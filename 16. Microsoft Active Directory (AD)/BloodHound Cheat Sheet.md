# Index
- [[Red Team/4. Tool Guides/0. Incomplete/Tool Guides]]

# BloodHound

BloodHound is an Active Directory (AD) reconnaissance tool that uses graph theory to reveal the hidden and often unintended relationships within an AD environment. It's a powerful tool used to identify attack paths and potential privilege escalation opportunities within a domain. This ultimate cheat sheet provides an exhaustive list of BloodHound commands, advanced usage scenarios, and detailed penetration testing techniques.

## Basic Components

- **BloodHound Interface**: A graphical interface used to visualize and analyze the collected data.
- **SharpHound**: The data collector that gathers information from the Active Directory environment.
- **Neo4j Database**: A graph database that stores the collected data, used by BloodHound for visualization.

# Setup and Configuration

#### Installing BloodHound
1. **Install Neo4j Database**: Installs the Neo4j graph database, required for BloodHound.
    ```bash
    sudo apt-get update
    sudo apt-get install neo4j
    ```
 2. **Start Neo4j Service**: Starts the Neo4j service.
    ```bash
    sudo systemctl start neo4j
    ```
 3. **Set Up Neo4j Database**: Access Neo4j in your browser at `http://localhost:7474` and set a new password.
 4. **Install BloodHound**: Installs the BloodHound interface.
    ```bash
    sudo apt-get install bloodhound
    ```
 5. **Launch BloodHound**: Opens the BloodHound interface in a browser.
    ```bash
    bloodhound
    ```
 6. **Connect BloodHound to Neo4j**: Use the Neo4j credentials to connect BloodHound to the database.
 
#### Collecting Data with SharpHound

1. **SharpHound Installation**: Download the SharpHound binary from the BloodHound GitHub repository or build it from source.
 2. **Running SharpHound**: Collects all available data from the domain. Other common options include:
	- `-c Session`: Collects user sessions.
	- `-c ACL`: Collects ACLs.
	- -`-c Trusts`: Collects domain trust information.
    ```bash
    SharpHound.exe -c All
    ```
 3. **Running SharpHound from PowerShell**: Imports the SharpHound PowerShell module and collects data using specified methods.
    ```bash
    Import-Module .\SharpHound.ps1
    Invoke-BloodHound -CollectionMethod All
    ```
 4. **Compressing the Collected Data**: Compresses the output data, reducing its size for easier transfer.
    ```bash
    SharpHound.exe -c All -CompressData
    ```
 5. **Upload Collected Data to BloodHound**: Drag and drop the `.zip` files generated by SharpHound into the BloodHound interface for analysis.
 
# Commands and Use Cases

#### Collection Methods
SharpHound offers multiple collection methods to gather different types of data from the domain.

1. **All Collection Methods**: Runs all available collection methods.
    ```bash
    SharpHound.exe -c All
    ```
 2. **Collecting Specific Data**: Replace `<method>` with:
	- `Default`: Default collection of common information.
	- `Group`: Collects AD group memberships.
	- `ACL`: Gathers information on ACLs.
	- `Session`: Collects information on user sessions.
	- `Trusts`: Collects information on domain trusts.
	- `DCOnly`: Collects data only from domain controllers.
	- `LoggedOn`: Collects logged-on user information.
    ```bash
    SharpHound.exe -c <method>
    ```
 3. **Stealth Collection (Avoiding Detection)**: Uses a stealthier approach, avoiding high-noise collection methods to reduce detection risk.
    ```bash
    SharpHound.exe -c Stealth
    ```
 4. **Targeted Collection**: Targets a specific domain while omitting domain trust information.
    ```bash
    SharpHound.exe -c All -Domain <target_domain> -OmitDomainTrusts
    ```
 5. **Collect Data from Specific Hosts**: Specifies a file containing a list of hostnames or IPs from which to collect data.
    ```bash
    SharpHound.exe -c All -ComputerFile <host_file.txt>
    ```
 6. **Limiting Collection to Specific User/Group**: Uses specific LDAP credentials to limit data collection to a specific user or group.
    ```bash
    SharpHound.exe -c All -LdapUsername <username> -LdapPassword <password>
    ```
 
#### Output and Data Management

1. **Export Data in JSON Format**: Exports the collected data as JSON files to the specified directory.
    ```bash
    SharpHound.exe -c All -JSONFolder <output_directory>
    ```
2. **Compress Data Automatically**: Compresses the data into `.zip` files after collection.
    ```bash
    SharpHound.exe -c All -CompressData
    ```
3. **Limit Data Collection to Specific Object Types**: Limits data collection to ACLs and saves the output to the specified directory.
    ```bash
    SharpHound.exe -c ACL -OutputDirectory <output_directory>
    ```
4. **Combine Multiple Data Sources**: Combines multiple JSON data files into one for a consolidated analysis.
    ```bash
    cat *.json > combined.json
    SharpHound.exe -c All -OutputDirectory <output_directory> -AppendData combined.json
    ```
5. **Schedule Regular Data Collection**: Schedules a daily data collection task to keep BloodHound updated.
    ```bash
    schtasks /create /tn "BloodHoundCollection" /tr "SharpHound.exe -c All -CompressData -OutputDirectory <output_directory>" /sc daily /st 02:00
    ```

#### Using Queries in BloodHound

1. **Find All Domain Admins**: Identifies all users who are members of the Domain Admins group.
    ```bash
    MATCH (u:User)-[:MemberOf*1..]->(g:Group {name:"DOMAIN ADMINS"}) RETURN u
    ```
2. **Find Paths to Domain Admins**: Finds the shortest path from a specific user to the Domain Admins group.
    ```bash
    MATCH p=shortestPath((u:User {name:"<username>"})-[r:MemberOf*1..]->(g:Group {name:"DOMAIN ADMINS"})) RETURN p
    ```
3. **Identify Privilege Escalation Paths**:  Identifies all potential privilege escalation paths to the Domain Admins group.
    ```bash
    MATCH p=allShortestPaths((u:User)-[r:AdminTo|MemberOf|HasSession|CanRDP|CanPSRemote|ExecuteDCOM*1..]->(g:Group {name:"DOMAIN ADMINS"})) RETURN p
    ```
4. **Find Users with Kerberos Delegation Privileges**:  Finds users with Kerberos delegation privileges, which can be exploited for privilege escalation.
    ```bash
    MATCH (u:User)-[:MemberOf]->(g:Group {name:"DOMAIN ADMINS"}), (u)-[:TrustedToAuth]-(d:Computer) RETURN u,d
    ```
5. **List All Computers with Unconstrained Delegation**: Lists all computers configured with unconstrained delegation, a common misconfiguration that can be exploited.
    ```bash
    MATCH (c:Computer {unconstraineddelegation:true}) RETURN c.name
    ```
6. **Identify LAPS Passwords**: Identifies objects that have read access to LAPS passwords, which can be used to compromise local admin accounts.
    ```bash
    MATCH (n)-[r:ReadLAPSPassword]->(m) RETURN n.name, m.name
    ```

#### Custom Queries for Targeted Analysis

1. **Identify Users with SPN Set**: Lists users who have a Service Principal Name (SPN) set, which may be susceptible to Kerberoasting attacks.
    ```bash
    MATCH (u:User {hasspn:true}) RETURN u.name
    ```
2. **Find All Groups with Admin Rights on a Specific Computer**: Lists all groups with administrative rights on a specified computer.
    ```bash
    MATCH (c:Computer {name:"<computer_name>"})<-[r:AdminTo]-(g:Group) RETURN g.name
    ```
3. **Determine Attack Paths to High-Value Targets**: Identifies the shortest attack paths from a specific user to high-value targets, such as domain controllers.
    ```bash
    MATCH p=shortestPath((u:User {name:"<username>"})-[r:AdminTo|MemberOf|HasSession*1..]->(h:Computer {name:"<high_value_target>"})) RETURN p
    ```
4. **List All Active Directory Trusts**: Lists all Active Directory trusts, which could be leveraged in cross-domain attacks.
    ```bash
    MATCH (d:Domain)-[r:TrustedBy]->(t:Domain) RETURN d.name, t.name
    ```
5. **Identify Users with Delegation Rights**: Identifies users with rights to delegate authentication to other computers.
    ```bash
    MATCH (u:User)-[:AllowedToDelegate]->(c:Computer) RETURN u.name, c.name
    ```

# Penetration Testing Techniques

#### External Reconnaissance

BloodHound is typically used within an internal network, but preparatory reconnaissance is essential for understanding the attack surface.

1. **Enumerating Domain Information**: Uses Nmap to enumerate LDAP information from a domain controller, which can be used to map the AD structure before using BloodHound.
    ```bash
    nmap --script ldap-search -p 389 <target_ip>
    ```
2. **DNS Zone Transfer**: Performs a DNS zone transfer to gather information about domain structure and internal network configuration.
    ```bash
    dig @<domain_controller_ip> <domain_name> axfr
    ```
3. **Collecting Initial User Information**: Uses SMB to enumerate domain users, which provides initial data for BloodHound.
    ```bash
    rpcclient -U "" -N <target_ip> -c enumdomusers
    ```
4. **Using OSINT for AD Reconnaissance**: Gathers public information on employees, which can help identify potential users and groups within the AD environment.
    ```bash
    theHarvester -d <target_domain> -b linkedin
    ```

5. **Gaining Initial Access**: Before using BloodHound, an attacker needs to gain access to the internal network. Common methods include phishing, exploiting vulnerabilities, or using compromised credentials.

#### Initial Access and Data Collection

Once inside the network, BloodHound can be used to map out the environment and identify potential attack paths.

1. **Deploying SharpHound After Gaining a Foothold**: Runs SharpHound to gather comprehensive data on the domain after gaining initial access.
    ```bash
    SharpHound.exe -c All -CompressData -OutputDirectory <output_directory>
    ```
2. **Evading Detection During Collection**: Uses stealth collection methods to avoid triggering alerts during data collection.
    ```bash
    SharpHound.exe -c All -Stealth -OutputDirectory <output_directory>
    ```
3. **Targeted Data Collection for Specific Groups**: Collects data related to a specific group, such as Domain Admins or other high-privilege groups.
    ```bash
    SharpHound.exe -c Group -GroupName <target_group>
    ```
4. **Using BloodHound in Post-Exploitation**: After compromising a host, use BloodHound to map out further attack paths and identify high-value targets within the network.
    ```bash
    Invoke-BloodHound -CollectionMethod All
    ```
5. **Collecting Data from a Domain Controller**: Gathers data specifically from domain controllers, which are critical targets in AD environments.
    ```bash
    SharpHound.exe -c DCOnly
    ```

#### Persistence Techniques

BloodHound can help identify ways to maintain persistence within a network by uncovering hidden relationships and potential backdoors.

1. **Identifying Persistent Admin Rights**: Finds users with persistent admin rights on specific computers, which can be leveraged to maintain access.
    ```bash
    MATCH (u:User)-[:AdminTo]->(c:Computer) WHERE c.name = "<target_computer>" RETURN u.name, c.name
    ```
2. **Establishing Persistence via ACL Misconfigurations**: Exploits ACL misconfigurations to establish persistent access to critical resources.
    ```bash
    MATCH (n)-[r:HasSession]->(u:User {name:"<username>"})-[a:AdminTo]->(c:Computer) RETURN r,a,c
    ```
3. **Using Kerberos Delegation for Persistence**: Leverages Kerberos delegation privileges to maintain access and move laterally within the network.
    ```bash
    MATCH (u:User)-[:TrustedToAuth]->(c:Computer {name:"<target_computer>"}) RETURN u.name, c.name
    ```
4. **Persistent Access Through Group Membership**: Identifies persistent access through group memberships, which can be abused for long-term control.
    ```bash
    MATCH (g:Group {name:"<group_name>"})<-[:MemberOf*1..]-(u:User) RETURN u.name
    ```
5. **Exploiting Domain Trusts for Persistence**: Exploits domain trusts to maintain persistence across multiple domains.
    ```bash
    MATCH (d:Domain)-[r:TrustedBy]->(t:Domain {name:"<target_domain>"}) RETURN d.name, t.name
    ```

#### Privilege Escalation

BloodHound excels at identifying paths to escalate privileges within an AD environment, particularly paths that are not immediately obvious.

1. **Path to Domain Admin**: Finds the shortest path from a compromised user to the Domain Admins group, a common privilege escalation target.
    ```bash
    MATCH p=shortestPath((u:User {name:"<username>"})-[r:AdminTo|MemberOf*1..]->(g:Group {name:"DOMAIN ADMINS"})) RETURN p
    ```
2. **Exploiting Kerberoasting Opportunities**: Identifies users with SPNs that can be targeted for Kerberoasting, allowing attackers to escalate privileges by cracking service tickets.
    ```bash
    MATCH (u:User {hasspn:true}) RETURN u.name
    ```
3. **Escalating Privileges via DCOM or PSRemote**: Identifies paths to escalate privileges through DCOM or PSRemote permissions.
    ```bash
    MATCH p=shortestPath((u:User {name:"<username>"})-[r:CanPSRemote|ExecuteDCOM]->(c:Computer {name:"<target_computer>"})) RETURN p
    ```
4. **Leveraging LAPS to Escalate Privileges**: Exploits access to LAPS-managed passwords to escalate privileges on target computers.
    ```bash
    MATCH (n)-[r:ReadLAPSPassword]->(m) RETURN n.name, m.name
    ```
5. **Using BloodHound to Find Privileged Accounts**: Identifies privileged accounts flagged as high-value targets, which are critical for escalation attempts.
    ```bash
    MATCH (u:User {highvalue:true}) RETURN u.name
    ```

#### Lateral Movement

BloodHound is invaluable for planning lateral movement within a network, particularly in complex AD environments with multiple domains and trust relationships.

1. **Finding Lateral Movement Paths**: Identifies all possible lateral movement paths from a compromised user account to other computers in the domain.
    ```bash
    MATCH p=allShortestPaths((u:User {name:"<username>"})-[r:AdminTo|HasSession|CanRDP|CanPSRemote*1..]->(c:Computer)) RETURN p
    ```
2. **Moving Laterally Using RDP**: Finds computers that a user can access via RDP, facilitating lateral movement.
    ```bash
    MATCH (u:User {name:"<username>"})-[r:CanRDP]->(c:Computer) RETURN u.name, c.name
    ```
3. **Lateral Movement via Service Accounts**: Identifies service accounts with admin rights on multiple computers, which can be used for lateral movement.
    ```bash
    MATCH (u:User {hasspn:true})-[r:AdminTo]->(c:Computer) RETURN u.name, c.name
    ```
4. **Exploiting Delegation for Lateral Movement**: Leverages Kerberos delegation to move laterally between systems.
    ```bash
    MATCH (u:User)-[:TrustedToAuth]->(c:Computer) RETURN u.name, c.name
    ```
5. **Cross-Domain Lateral Movement**: Explores domain trusts to plan lateral movement across domains.
    ```bash
    MATCH (d:Domain)-[r:TrustedBy]->(t:Domain) WHERE d.name = "<source_domain>" AND t.name = "<target_domain>" RETURN r
    ```

### Defense Evasion

BloodHound can also be used to identify ways to evade detection by security mechanisms within the network, making it a valuable tool for maintaining stealth during operations.

1. **Identifying and Avoiding Security Groups**: Identifies users who are members of security-sensitive groups to avoid triggering alarms.
    ```bash
    MATCH (g:Group {name:"<security_group>"})<-[:MemberOf*1..]-(u:User) RETURN u.name
    ```
2. **Exploiting ACL Misconfigurations for Stealth**: Exploits ACL misconfigurations on non-sensitive systems to avoid detection.
    ```bash
    MATCH (u:User {name:"<username>"})-[r:AdminTo]->(c:Computer) WHERE c.sensitive=false RETURN u.name, c.name
    ```
3. **Using Unmonitored Accounts**: Finds unmonitored accounts that can be used for stealthy operations.
    ```bash
    MATCH (u:User)-[:MemberOf]->(g:Group {name:"<unmonitored_group>"}) RETURN u.name
    ```
4. **Evading Detection via Low-Value Targets**: Identifies low-value targets that are less likely to be monitored closely by security teams.
    ```bash
    MATCH (c:Computer {highvalue:false})<-[r:AdminTo]-(u:User {name:"<username>"}) RETURN u.name, c.name
    ```
5. **Minimizing Noise in BloodHound Collection**: Reduces the risk of detection by using stealth collection methods that minimize noise and avoid triggering alerts.
    ```bash
    SharpHound.exe -c Stealth
    ```

### Data Exfiltration

While BloodHound itself is not typically used for data exfiltration, it can identify paths and methods that would allow an attacker to exfiltrate data from the network.

1. **Identifying Exfiltration Paths via Unmonitored Systems**: Finds systems that are unmonitored, making them ideal candidates for data exfiltration.
    ```bash
    MATCH (c:Computer {unmonitored:true}) RETURN c.name
    ```
2. **Leveraging Trust Relationships for Exfiltration**: Uses domain trusts to exfiltrate data across domain boundaries, making detection more difficult.
    ```bash
    MATCH (d:Domain)-[r:TrustedBy]->(t:Domain {name:"<target_domain>"}) RETURN r
    ```
3. **Using Delegation to Access Sensitive Data**: Exploits delegation to access and exfiltrate sensitive data from critical systems.
    ```bash
    MATCH (u:User)-[:TrustedToAuth]->(c:Computer {name:"<sensitive_data_host>"}) RETURN u.name, c.name
    ```
4. **Exfiltration via Low-Value Targets**: Uses low-value systems to exfiltrate data, reducing the likelihood of detection.
    ```bash
    MATCH (c:Computer {highvalue:false})<-[r:AdminTo]-(u:User {name:"<username>"}) RETURN u.name, c.name
    ```
5. **Cross-Domain Exfiltration**: Identifies cross-domain trust relationships that can be exploited for exfiltrating data out of the network.
    ```bash
    MATCH (d:Domain)-[r:TrustedBy]->(t:Domain) WHERE t.name = "<external_domain>" RETURN r
    ```

# Resources

|**Name**|**URL**|
|---|---|
|BloodHound GitHub Repository|https://github.com/BloodHoundAD/BloodHound|
|BloodHound Documentation|https://bloodhound.readthedocs.io/|
|SharpHound Collection Methods|https://bloodhound.readthedocs.io/en/latest/sharphound.html|
|BloodHound Queries|https://github.com/BloodHoundAD/BloodHound-Tools|
|Advanced BloodHound Techniques|https://posts.specterops.io/a-deeper-look-at-bloodhound-analysis-using-custom-queries-105f3f8fbf1|
|BloodHound Pathfinding Techniques|https://www.cobaltstrike.com/help-bloodhound|
|BloodHound in Red Team Operations|https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/using-bloodhound-in-red-team-operations|
|Neo4j Database Administration|https://neo4j.com/developer/graph-database/|
|Defense Evasion with BloodHound|https://posts.specterops.io/bloodhound-and-defensive-evasion-part-1-neo4j-invisibility-46f410e2e1f|
|Using BloodHound for Privilege Escalation|https://pentestlab.blog/2020/05/06/privilege-escalation-using-bloodhound/|