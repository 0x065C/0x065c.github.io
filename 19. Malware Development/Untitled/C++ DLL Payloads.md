# Guide to Building a Custom DLL in Visual Studio Using C++

This guide will walk you through the process of creating a custom Dynamic Link Library (DLL) from scratch using Visual Studio and C++. We will create a DLL that exports a function to open a PowerShell session window. Additionally, we'll cover post-compile testing steps to ensure your DLL works as expected.

# Prerequisites

- Visual Studio: Ensure you have Visual Studio installed (Community Edition is sufficient).
- Basic Knowledge of C++: Familiarity with C++ programming.
- Administrative Rights: May be required for certain operations.

# Step 1: Setting Up the DLL Project

1. Open Visual Studio.

2. Create a New Project:
   - Go to File > New > Project.

3. Select Project Type:
   - In the New Project dialog, select Visual C++ > Windows Desktop.
   - Choose Dynamic-Link Library (DLL).

4. Configure Project:
   - Name: Enter a name for your project, e.g., `PowerShellDLL`.
   - Location: Choose a location to save the project.
   - Click OK.

5. Set Application Type:
   - In the Windows Desktop Project dialog, ensure DLL is selected.
   - Uncheck Precompiled Header if you prefer not to use it.
   - Click Finish.

# Step 2: Writing the DLL Code

1. Add a New Source File:
   - Right-click on the Source Files folder in Solution Explorer.
   - Select Add > New Item.
   - Choose C++ File (.cpp).
   - Name: Enter `PowerShellDLL.cpp`.
   - Click Add.

2. Include Necessary Headers:

   ```cpp
   #include <windows.h>
   ```

3. Write the Function to Open PowerShell:

   ```cpp
   extern "C" __declspec(dllexport) void OpenPowerShell()
   {
       ShellExecute(NULL, "open", "powershell.exe", NULL, NULL, SW_SHOW);
   }
   ```

   - Explanation:
     - `extern "C"`: Prevents name mangling to ensure the function name is exported correctly.
     - `__declspec(dllexport)`: Tells the compiler to export the function.
     - `ShellExecute`: Windows API function to execute a program.

# Step 3: Exporting the Function

To ensure that the `OpenPowerShell` function is exported correctly, you can use a Module Definition File (.def).

1. Add a Module Definition File:
   - Right-click on the Project in Solution Explorer.
   - Select Add > New Item.
   - Choose Module-Definition File (.def).
   - Name: Enter `PowerShellDLL.def`.
   - Click Add.

2. Edit the .def File:

   ```def
   LIBRARY "PowerShellDLL"
   EXPORTS
       OpenPowerShell
   ```

# Step 4: Building the DLL

1. Build Configuration:
   - Set the build configuration to Release for a final build or Debug for testing.
   - Choose the appropriate Platform (x86 or x64).

2. Build the Project:
   - Go to Build > Build Solution.
   - Check the Output Window for any errors.
   - The DLL file (`PowerShellDLL.dll`) will be generated in the project's `Release` or `Debug` folder.

# Step 5: Creating a Test Application

To test the DLL, we'll create a simple console application that calls the `OpenPowerShell` function.

1. Create a New Project:
   - Go to File > New > Project.
   - Select Visual C++ > Console Application.
   - Name: Enter `TestApp`.
   - Click OK.

2. Disable Precompiled Headers (Optional):
   - Right-click on the `TestApp` project.
   - Select Properties.
   - Navigate to C/C++ > Precompiled Headers.
   - Set Precompiled Header to Not Using Precompiled Headers.
   - Click OK.

3. Add Source Code:
   - Replace the content of `TestApp.cpp` with the following code:

     ```cpp
     #include <windows.h>
     #include <iostream>

     typedef void (*OpenPowerShellFunc)();

     int main()
     {
         // Load the DLL
         HINSTANCE hinstDLL = LoadLibrary("PowerShellDLL.dll");
         if (hinstDLL != NULL)
         {
             // Get the function address
             OpenPowerShellFunc OpenPowerShell = (OpenPowerShellFunc)GetProcAddress(hinstDLL, "OpenPowerShell");
             if (OpenPowerShell != NULL)
             {
                 // Call the function
                 OpenPowerShell();
                 std::cout << "PowerShell window should now be open." << std::endl;
             }
             else
             {
                 std::cerr << "Failed to find function." << std::endl;
             }
             // Free the DLL
             FreeLibrary(hinstDLL);
         }
         else
         {
             std::cerr << "Failed to load DLL." << std::endl;
         }
         return 0;
     }
     ```

# Step 6: Testing the DLL

1. Configure Test Application Dependencies:

   - Copy the DLL:
     - Copy `PowerShellDLL.dll` from the DLL project's output directory to the `TestApp` project's output directory (e.g., `TestApp\Debug`).

   - Ensure the DLL is Accessible:
     - Alternatively, you can place the DLL in a system path or modify the environment PATH variable.

2. Build the Test Application:
   - Right-click on the `TestApp` project.
   - Select Build.

3. Run the Test Application:
   - Press Ctrl + F5 or go to Debug > Start Without Debugging.
   - Expected Outcome:
     - A PowerShell window should open.
     - The console should display: `PowerShell window should now be open.`

4. Troubleshooting:

   - DLL Load Failures:
     - Ensure that the DLL is in the same directory as the executable or in a directory that's part of the system PATH.
   - Function Not Found:
     - Verify that the function name matches between the DLL and the test application.
     - Ensure that the function is properly exported.