# Index
- [[Back End Vulnerabilities]]
	- [[1. Insecure File Uploads]]
	- [[2. File Inclusion]]
	- [[3. Command Injection]]
	- [[4. SQL Injection (SQLi)]]
	- [[5. Server-Side Request Forgery (SSRF)]]
	- [[6. Server-Side Template Injection (SSTi)]]
	- [[7. XML External Entity (XXE)]]
	- [[8. Insecure Deserialization]]

# File Extension Filter Bypass

File Extension Filter Bypasses are techniques used by attackers to circumvent file upload restrictions imposed by web applications. These restrictions are often in place to prevent the upload of potentially harmful files, such as scripts or executables. By manipulating the file extension or utilizing alternative methods to disguise the true nature of the file, attackers can successfully upload malicious files and gain unauthorized access or execute arbitrary code on the server.

#### Features

- **Manipulation of File Extensions:** Changing or adding extensions to bypass filters.
- **Double Extensions:** Using multiple extensions to confuse the filter (e.g., `shell.php.jpg`).
- **Null Byte Injection:** Using null bytes to truncate the extension (e.g., `shell.php%00.jpg`).
- **MIME Type Spoofing:** Altering the MIME type to match allowed file types.
- **Directory Traversal:** Exploiting directory traversal to place files in unintended directories.

#### Typical Use Cases

- Gaining unauthorized access to web servers.
- Executing arbitrary code.
- Uploading web shells for persistent access.
- Circumventing security measures to escalate privileges.

# Commands and Usage
Here are the methods to bypass MIME type filtering:

#### File Renaming/Change File Extension
In some cases, simply changing the file extension can bypass the filtering. Uploading the file with an allowed extension and then changing it on the server side can be effective if the application allows file renaming or moving.

1. **Create a Malicious File:**    
    - Create a PHP file named `shell.php`.

2. **Rename the File:**    
    - Rename `shell.php` to `shell.jpg`.

3. **Upload the File:**    
    - Upload `shell.jpg`.

4. **Find a Way to Rename or Move the File:**    
    - If there is functionality to rename or move files, use it to change `shell.jpg` to `shell.php`.

5. **Access the File:**    
    - Try accessing the uploaded file via URL:
	`http://<target_ip>:<target_port>/uploads/shell.php`

#### Double Extension
Using double extensions is one of the simplest methods. If the server only checks the file extension, you can append a benign extension to the end. Appending a second allowed extension after a dangerous one can sometimes trick the server into accepting the file as benign.

1. **Create a Malicious File:**    
    - Create a PHP file with the following content:
    `<?php phpinfo(); ?>`
    - Save it as `shell.php`.

2. **Rename the File:**   
    - Rename `shell.php` to `shell.php.jpg`.

3. **Upload the File:**    
    - Navigate to the file upload section of the target application.
    - Upload `shell.php.jpg`.

4. **Access the File:**    
    - Try accessing the uploaded file via URL:
	`http://<target_ip>:<target_port>/uploads/shell.php.jpg`  
    - If the server executes the PHP code, the filter is bypassed.

#### Obfuscation -Null Byte Injection
Some web applications are vulnerable to null byte injection, which can be used to bypass filtering by truncating the file extension. Inserting a null byte character (`%00`) to terminate the filename can bypass filters that do not properly handle null byte characters.

1. **Create a Malicious File:**    
    - Create a PHP file named `shell.php` with the same content as above.

2. **Intercept the Request Using Burp Suite:**    
    - Open Burp Suite and enable the Proxy.
    - Navigate to the upload section and select the `shell.php` file.
    - Intercept the request in Burp Suite.
    - Modify the filename in the request to `shell.php%00.jpg`.

3. **Forward the Request:**    
    - Forward the modified request to the server.

4. **Access the File:**    
    - Try accessing the uploaded file via URL:
    `http://<target_ip>:<target_port>/uploads/shell.php`

#### Obfuscation - Filtered Characters
Using special characters to disguise the extension.

`mv shell.php shell.p\h\p`

#### Obfuscation - Whitespace Characters
Inserting spaces before or after the extension.

`mv shell.php "shell.php "`

#### Content-Type Header Manipulation
Some applications rely on the `Content-Type` header sent by the client to determine the MIME type. This can be manipulated using tools like Burp Suite. Altering the MIME type in the request headers to an allowed type can bypass server-side checks.

1. **Create a Malicious File:**    
    - Create a PHP file named `shell.php`.

2. **Intercept the Request Using Burp Suite:**    
    - Open Burp Suite and enable the Proxy.
    - Navigate to the upload section and select the `shell.php` file.
    - Intercept the request in Burp Suite.
    - Modify the `Content-Type` header to `image/jpeg`.

3. **Forward the Request:**    
    - Forward the modified request to the server.

4. **Access the File:**    
    - Try accessing the uploaded file via URL:
	`http://<target_ip>:<target_port>/uploads/shell.php`

#### PHP File with Image Headers
Browsers sometimes perform MIME sniffing, which means they interpret files differently based on their content rather than their declared type. You can exploit this by uploading a file with a legitimate extension but containing executable content. Embedding PHP code inside an image file can trick the server into accepting it as an image while still executing the PHP code.

1. **Create a Malicious File:**    
    - Create a PHP file named `shell.php` with the following content:
	`<?php phpinfo(); ?>`        
    - Add valid image headers (e.g., using a hex editor) to the beginning of the file.

2. **Upload the File:**    
    - Upload the file as an image (e.g., `shell.jpg`).

3. **Access the File:**    
    - Try accessing the uploaded file via URL:
	`http://<target_ip>:<target_port>/uploads/shell.jpg`

#### Using Polyglots
Polyglot files are crafted to be valid in multiple formats and can be interpreted as multiple types depending on the context. An attacker can create a file that is both a valid image and a script. For example, a GIF file with embedded PHP code.

Example:

```
GIF89a;
<?php echo 'This is a PHP code'; ?>
```

Save this file with a `.gif` extension and upload it.

# Tools and Commands

#### Using Burp Suite for Proxy Interception

1. **Intercept Request:**    
    - Open Burp Suite and enable the Proxy.
    - Navigate to the file upload section of the target application.
    - Upload a file and intercept the request.

2. **Modify Request:**    
    - Modify the filename or headers as needed (e.g., `shell.php.jpg`, `shell.php%00.jpg`, change MIME type).

3. **Forward Request:**    
    - Forward the modified request to the server.

#### Using cURL for Manual Upload

1. **Basic File Upload Command:**
	`curl -X POST -F "file=@shell.php.jpg" http://<target_ip>:<target_port>/upload.php`    

2. **Modify MIME Type:**
	`curl -X POST -F "file=@shell.php;type=image/jpeg" http://<target_ip>:<target_port>/upload.php`

#### Example Attack Scenario

Target: `http://192.168.1.100:8080/upload.php`
Attack IP: `192.168.1.50`
Attack Port: `8080`

1. **Create a PHP Shell:**
	`<?php echo "Hello, world"; ?>`    
    - Save as `shell.php`.

2. **Using Double Extension Bypass:**    
    - Rename `shell.php` to `shell.php.jpg`.
    - Upload the file.
    - Access the file at:
	`http://192.168.1.100:8080/uploads/shell.php.jpg`

3. **Using Null Byte Injection:**    
    - Intercept the request using Burp Suite.
    - Modify the filename to `shell.php%00.jpg`.
    - Forward the request.
    - Access the file at:
	`http://192.168.1.100:8080/uploads/shell.php`        

4. **Using MIME Type Manipulation:**    
    - Intercept the request using Burp Suite.
    - Modify the `Content-Type` header to `image/jpeg`.
    - Forward the request.
    - Access the file at:
	`http://192.168.1.100:8080/uploads/shell.php`        

5. **Using cURL:**
	`curl -X POST -F "file=@shell.php.jpg" http://192.168.1.100:8080/upload.php`

# Additional Information

#### Advanced Options

- **Content Inspection Evasion:** Use tools like `Burp Suite` to modify the file content slightly to evade content-based filters.
- **Server-Specific Exploits:** Some web servers or configurations might have unique vulnerabilities or quirks that can be exploited.
- **Directory Traversal:** Combine file extension bypass with directory traversal to place files in sensitive directories.

#### Secondary Functions

- **Persistence:** Uploaded web shells can be used to maintain access.
- **Privilege Escalation:** Exploit the server further to escalate privileges.

#### Unique Circumstantial Information

- **File Upload Directory Permissions:** Understanding where files are stored and what permissions they have can aid in planning the next steps after bypassing the filter.
- **Server Configuration:** Different servers (Apache, Nginx, IIS) might handle file uploads and MIME types differently.

# Resources

|**Website**|**URL**|
|-|-|
|OWASP File Upload Vulnerabilities|https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload|
|PortSwigger Web Security Academy: File Upload Vulnerabilities|https://portswigger.net/web-security/file-upload|
|HackTricks File Uploads Cheatsheet|https://book.hacktricks.xyz/pentesting-web/file-upload|
|Burp Suite Documentation: File Upload Attacks|https://portswigger.net/burp/documentation/desktop/testing-workflow/using-burp-to-test-for-file-upload-vulnerabilities|
|PayloadsAllTheThings: File Upload|[https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files)|
